802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1


    1	                                
    2	                                ; CBIOS FOR TELEVIDEO TS-802 SYSTEM
    3	                                
    4	                                ;	COPYRIGHT (C) 1981
    5	                                ;	TELEVIDEO SYSTEMS INC.
    6	                                ;	1170 MORSE AVENUE 
    7	                                ;	SUNNYVALE, CA 94086
    8	                                ;	(408) 745-7760
    9	                                
   10	                                ; 	VERSION	V2.0	(RELEASE)
   11	                                
   12	                                ;	7-24-81		SUNG WOO LEE
   13	                                ;	- SIGN-ON MESSAGE CHANGE
   14	                                
   15	                                ;	8-25-81		SUNG WOO LEE
   16	                                ;	- ENHANCEMENT FOR REV. B
   17	                                ;	  -- DRIVE DOOR OPEN MESSAGE
   18	                                ;	  -- DETAILED ERROR MESSAGE
   19	                                ;	  -- DISK DRIVE MOTOR & LIGHT OFF WHEN UNUSED
   20	                                ;	  -- NO SEEK ON THE SAME TRACK
   21	                                ;	  -- NO SELECT DRIVE FOR THE SAME
   22	                                ;	  -- PRINTER INTERFACE WITH EPSON SERIAL AS DEFAULT
   23	                                ;	  -- SIO #1 ADDED TO SERVE FOR PRINTER THROUGH CH. B
   24	                                
   25	                                ;	12-10-81	SUNG WOO LEE
   26	                                ;	- REMOVED CTC CH #1 INITIALIZATION ROUTINE NOT TO CHANGE
   27	                                ;	  THE BAUD RATE SET UP BY PROM FOR PRINTER
   28	                                
   29	                                ;	TeleVideo Systems Incorporated Proprietary Information.
   30	                                ;	This listing is supplied under the terms of a license
   31	                                ;	agreement with TeleVideo Systems Incorporated and may
   32	                                ;	not be copied nor disclosed except in accordance with
   33	                                ;	the terms of that agreement.
   34	                                
   35	                                
   36	                                	TITLE 802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 
   37	                                
   38	                                
   39	                                	.Z80
   40	  0000'                         	CSEG
   41	                                	.PHASE 0F200H
   42	                                
   43	                                ;********************************
   44	                                ; THE FOLLOWING EQUATES ARE KEPT*
   45	                                ; ISOLATED FROM THE REST FOR	*
   46	                                ; PURPOSES OF MOVCPM GENERATION.*
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-1


   47	                                ;********************************
   48	                                
   49	  DC00                          CPMBAS	EQU	$-BDOSLN		; BASE OF CP/M (CCP)
   50	  E406                          BDOS	EQU	CPMBAS+CCPLEN+6		; ADDRESS OF BDOS ENTRY
   51	                                
   52	                                	SUBTTL 802FBOOT.MAC--BOOTSTRAP MODULE
   53	                                	PAGE
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-2
802FBOOT.MAC--BOOTSTRAP MODULE

   54	                                
   55	                         C      	INCLUDE 802FBOOT.MAC
   56	                         C      
   57	                         C      ;  **************** BIOS JUMP TABLE *****************
   58	                         C      
   59	  F200    C3 F264        C      BIOS:	JP	BOOT
   60	  F203    C3 F280        C      	JP	WBOOT
   61	  F206    C3 F2FF        C      	JP	CONST
   62	  F209    C3 F325        C      	JP	CONIN
   63	  F20C    C3 F34F        C      	JP	CONOUT
   64	  F20F    C3 F388        C      	JP	LIST
   65	  F212    C3 F37C        C      	JP	PUNCH
   66	  F215    C3 F370        C      	JP	READER
   67	  F218    C3 F41D        C      	JP	HOME
   68	  F21B    C3 F42B        C      	JP	SELDSK
   69	  F21E    C3 F441        C      	JP	SETTRK
   70	  F221    C3 F446        C      	JP	SETSEC
   71	  F224    C3 F44B        C      	JP	SETDMA
   72	  F227    C3 F453        C      	JP	READ
   73	  F22A    C3 F467        C      	JP	WRITE
   74	  F22D    C3 F3ED        C      	JP	LISTST
   75	  F230    C3 F450        C      	JP	SECTRN
   76	  F233    C3 F417        C      	JP	UNUSED
   77	  F236    C3 F417        C      	JP	UNUSED
   78	  F239    C3 F417        C      	JP	UNUSED
   79	  F23C    C3 F417        C      	JP	UNUSED
   80	  F23F    C3 F417        C      	JP	UNUSED
   81	                         C      
   82	                         C      ; COPYRIGHT STATEMENT
   83	                         C      
   84	  F242    28 43 29 20    C      	DEFM	'(C) 1981, TELEVIDEO SYSTEMS INC.'
   85	  F246    31 39 38 31    C      
   86	  F24A    2C 20 54 45    C      
   87	  F24E    4C 45 56 49    C      
   88	  F252    44 45 4F 20    C      
   89	  F256    53 59 53 54    C      
   90	  F25A    45 4D 53 20    C      
   91	  F25E    49 4E 43 2E    C      
   92	                         C      
   93	                         C      ; VERSION AND REVISION NO.
   94	                         C      
   95	  F262    02             C      VER:	DEFB	2
   96	  F263    00             C      REV:	DEFB	0
   97	                         C      
   98	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-3
802FBOOT.MAC--BOOTSTRAP MODULE

   99	                         C      ; COME HERE FROM COLDSTART LOADER
  100	                         C      
  101	  F264    D3 04          C      BOOT:	OUT	(PROMSW),A	; SHUT PROM OFF (DEBUG)
  102	  F266    31 0100        C      	LD	SP,CPMBUF+80H	; INITIALIZE STACK POINTER
  103	  F269    21 F7AF        C      	LD	HL,SIGNON	; PRINT SIGNON MESSAGE
  104	  F26C    CD F6E4        C      	CALL	PRTMSG
  105	                         C      
  106	  F26F    AF             C      	XOR	A		; MAKE LOGGED DRIVE 0
  107	  F270    32 F876        C      	LD	(DRIVE),A	; SAVE IT FOR LATER
  108	  F273    32 0004        C      	LD	(LOGDRV),A
  109	  F276    3E 15          C      	LD	A,00010101B	; INITIALIZE IOBYTE
  110	  F278    32 0003        C      	LD	(IOBYTE),A
  111	  F27B    CD F6F5        C      	CALL	HDWINI		; INITIALIZE SYSTEM HARDWARE
  112	  F27E    18 54          C      	JR	GOCPM		; DO MORE INITIALIZATION
  113	                         C      
  114	                         C      ; WE JUMP TO HERE WHENEVER THE USER WANTS
  115	                         C      ; TO RESTART THE SYSTEM, I. E., REREAD CP/M
  116	                         C      ; WITHOUT MODIFYING THE BIOS
  117	                         C      
  118	  F280    31 0100        C      WBOOT:	LD	SP,CPMBUF+80H	; INITIALIZE STACK POINTER
  119	  F283    3E 0A          C      	LD	A,NOTRYS	; NUMBER OF RETRIES FOR BOOT
  120	  F285    32 F978        C      	LD	(BOOTRY),A	; STORE IT.	
  121	  F288    AF             C      	XOR	A		; PREVENT BUFFER FLUSH
  122	  F289    32 F983        C      	LD	(HSTACT),A	; CONDITION ON WRITE ERROR
  123	                         C      
  124	  F28C    CD F6AA        C      WBOO10:	CALL	RESDSK		; RESET DISK SUBSYSTEM
  125	                         C      
  126	                         C      ; INITIALIZE THE TRANSFER PARAMETERS
  127	                         C      
  128	  F28F    0E 00          C      	LD	C,0		; SELECT DRIVE ZERO
  129	  F291    CD F42B        C      	CALL	SELDSK		; FROM WHICH TO BOOT
  130	  F294    21 DC00        C      	LD	HL,CPMBAS	; INITIAL DMA ADDRESS
  131	  F297    11 0002        C      	LD	DE,0002H	; D=INITIAL TRACK, E=INITIAL SECTOR
  132	  F29A    06 2C          C      	LD	B,BDOSLN/RECLEN	; LENGTH OF TRANSFER, IN SECTORS
  133	                         C      
  134	  F29C    C5             C      WBOO20:	PUSH	BC		; SAVE REGISTERS
  135	  F29D    E5             C      	PUSH	HL
  136	  F29E    D5             C      	PUSH	DE
  137	  F29F    4D             C      	LD	C,L		; MOVE TRANSFER ADDRESS TO BC
  138	  F2A0    44             C      	LD	B,H
  139	  F2A1    CD F44B        C      	CALL	SETDMA		; SET DATA TRANSFER ADDRESS
  140	  F2A4    4A             C      	LD	C,D
  141	  F2A5    CD F441        C      	CALL	SETTRK		; SET TRACK REGISTER TO D
  142	  F2A8    4B             C      	LD	C,E
  143	  F2A9    CD F446        C      	CALL	SETSEC		; SET SECTOR REGISTER TO E	
  144	  F2AC    CD F453        C      	CALL	READ		; READ A SECTOR
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-4
802FBOOT.MAC--BOOTSTRAP MODULE

  145	  F2AF    28 11          C      	JR	Z,WBOO30	; READ SUCCESSFUL
  146	  F2B1    D1             C      	POP	DE		; ELSE RETORE REGISTERS
  147	  F2B2    E1             C      	POP	HL
  148	  F2B3    C1             C      	POP	BC
  149	  F2B4    21 F978        C      	LD	HL,BOOTRY	; CHECK ON RETRY SITUATION
  150	  F2B7    35             C      	DEC	(HL)
  151	  F2B8    20 D2          C      	JR	NZ,WBOO10	; MORE TRIES LEFT.
  152	  F2BA    21 F7E3        C      	LD	HL,BOOMSG	; PRINT ERROR MESSAGE
  153	  F2BD    CD F6E4        C      	CALL	PRTMSG
  154	  F2C0    18 FE          C      	JR	$		; AND DIE.
  155	                         C      
  156	  F2C2    D1             C      WBOO30:	POP	DE		; ADJUST TRACK AND SECTOR
  157	  F2C3    1C             C      	INC	E		; BUMP SECTOR NO.
  158	  F2C4    7B             C      	LD	A,E
  159	  F2C5    FE 48          C      	CP	SPT0		; END OF CURRENT TRACK?
  160	  F2C7    38 03          C      	JR	C,WBOO40	; NO.
  161	  F2C9    1E 00          C      	LD	E,0		; CYCLE THE SECTOR NO.
  162	  F2CB    14             C      	INC	D		; AND INCREMENT THE TRACK
  163	                         C      
  164	  F2CC    E1             C      WBOO40:	POP	HL		; RECALL THE TRANSFER ADDRESS
  165	  F2CD    01 0080        C      	LD	BC,RECLEN	; ADD IN A SECTOR
  166	  F2D0    09             C      	ADD	HL,BC
  167	  F2D1    C1             C      	POP	BC		; RESTORE SECTOR COUNT
  168	  F2D2    10 C8          C      	DJNZ	WBOO20		; GO READ NEXT SECTOR.	
  169	                         C      
  170	                         C      ; CODE SHARED BY BOTH WARM AND COLD STARTS
  171	                         C      
  172	  F2D4    01 0080        C      GOCPM:	LD	BC,CPMBUF	; INITIALIZE DMA ADDRESS
  173	  F2D7    CD F44B        C      	CALL	SETDMA
  174	  F2DA    3E C3          C      	LD	A,JP		; INITIALIZE LOW MEMORY
  175	  F2DC    32 0000        C      	LD	(0000H),A
  176	  F2DF    21 F203        C      	LD	HL,BIOS+3	; WARM BOOT JUMP ENTRY
  177	  F2E2    22 0001        C      	LD	(0001H),HL	; STORE IT
  178	  F2E5    32 0005        C      	LD	(0005H),A
  179	  F2E8    21 E406        C      	LD	HL,BDOS		; BDOS ENTRY POINT
  180	  F2EB    22 0006        C      	LD	(0006H),HL	; STORE IT
  181	  F2EE    AF             C      	XOR	A		; CLEAR SERIAL PRINTER BUFFER COUNT
  182	  F2EF    32 FA91        C      	LD	(UL1CNT),A	; ON COLD OR WARM START
  183	  F2F2    32 F985        C      	LD	(UNACNT),A	; UNALLOCATED SECTOR COUNT
  184	  F2F5    32 F983        C      	LD	(HSTACT),A	; BUFFER INACTIVE
  185	  F2F8    3A 0004        C      	LD	A,(LOGDRV)	; PASS LOGGED DRIVE NO.
  186	  F2FB    4F             C      	LD	C,A		; IN REG-C
  187	  F2FC    C3 DC00        C      	JP	CPMBAS		; TO CCP
  188	                         C      
  189	                         C      ; END OF 802FBOOT.MAC
  190	                                
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-5
802FCONS.MAC--CONSOLE I/O MODULE

  191	                                	SUBTTL 802FCONS.MAC--CONSOLE I/O MODULE
  192	                                	PAGE
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-6
802FCONS.MAC--CONSOLE I/O MODULE

  193	                                
  194	                         C      	INCLUDE 802FCONS.MAC
  195	                         C      
  196	                         C      ; TEST THE STATUS OF THE CONSOLE INPUT TO
  197	                         C      ; SEE IF A CHARACTER IS AVAILABLE.
  198	                         C      ;	EXIT:	A=0FFH	->	CHARACTER AVAILABLE
  199	                         C      ;		A=0	->	NO CHARACTER
  200	                         C      
  201	  F2FF    CD F6FF        C      CONST:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  202	  F302    00             C      	DEFB	0		; CONSOLE POSITION IN IOBYTE
  203	  F303    F30B           C      	DEFW	TTYST		; CONSOLE PRINTER DEVICE
  204	  F305    F31C           C      	DEFW	CRTST		; CONSOLE CRT DEVICE
  205	  F307    F41B           C      	DEFW	BATST		; CONSOLE BATCH DEVICE
  206	  F309    F41B           C      	DEFW	UC1ST		; USER DEFINED CONSOLE
  207	                         C      
  208	                         C      ; PRINTER STATUS ROUTINE FOR SERIAL
  209	                         C      ; INTERFACE WITH EPSON AND TI
  210	                         C      ; SIO #1 CHANNEL B
  211	                         C      
  212	  F30B    3E 10          C      TTYST:	LD	A,00010000B	; RESET EXTRN/STATUS COMMAND
  213	  F30D    D3 23          C      	OUT	(SIOBC1),A	; SEND OUT
  214	  F30F    DB 23          C      	IN	A,(SIOBC1)	; READ SIO STATUS
  215	  F311    E6 24          C      	AND	00100100B	; CHECK TRANSMITT READY AND CTS
  216	  F313    FE 24          C      	CP	00100100B	; READY TO SEND?
  217	  F315    28 02          C      	JR	Z,TTYS1		; YES, CODE FOR SET READY CONDITION
  218	  F317    AF             C      	XOR	A		; NO, SET NOT READY CONDITION
  219	  F318    C9             C      	RET
  220	                         C      
  221	  F319    AF             C      TTYS1:	XOR	A
  222	  F31A    3D             C      	DEC	A		; A = FF
  223	  F31B    C9             C      	RET
  224	                         C      
  225	                         C      ; CONSOLE STATUS ROUTINE FOR STANDARD
  226	                         C      ; CRT TERMINAL DEVICE, SIO #0 CHANNEL B.
  227	                         C      
  228	  F31C    DB 0F          C      CRTST:	IN	A,(SIOBC0)	; READ SIO STATUS
  229	  F31E    CB 47          C      	BIT	RCVRDY,A	; CHARACTER AVAILABLE?
  230	  F320    3E 00          C      	LD	A,0
  231	  F322    C8             C      	RET	Z		; NO. A = 0
  232	                         C      
  233	  F323    3D             C      	DEC	A		; YES. A = FFH
  234	  F324    C9             C      	RET
  235	                         C      
  236	                         C      ; GRAB A CHARACTER FROM CONSOLE INPUT.
  237	                         C      ;	EXIT:	A=RETURNED CHARACTER
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-7
802FCONS.MAC--CONSOLE I/O MODULE

  238	                         C      
  239	  F325    CD F6FF        C      CONIN:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  240	  F328    00             C      	DEFB	0		; CONSOLE POSITION IN IOBYTE
  241	  F329    F331           C      	DEFW	TTYIN		; CONSOLE PRINTER DEVICE
  242	  F32B    F332           C      	DEFW	CRTIN		; CONSOLE CRT DEVICE
  243	  F32D    F418           C      	DEFW	BATIN		; CONSOLE BATCH DEVICE
  244	  F32F    F418           C      	DEFW	UC1IN		; USER DEFINED CONSOLE
  245	                         C      
  246	                         C      ; JUST RETURN FOR NOW
  247	                         C      
  248	  F331    C9             C      TTYIN:	RET
  249	                         C      
  250	                         C      ; CONSOLE INPUT ROUTINE FOR
  251	                         C      ; STANDARD CRT TERMINAL DEVICE.
  252	                         C      ; SIO CHANNEL B.
  253	                         C      ; MOTOR AND LIGHT OFF IN HALF A SECOND
  254	                         C      ; WHEN THERE IS NO INPUT ON CONSOLE
  255	                         C      
  256	  F332    C5             C      CRTIN:	PUSH	BC
  257	  F333    01 8000        C      	LD	BC,8000H	; TIME-OUT FOR 1/2 SECOND
  258	  F336    CD F31C        C      CRT20:	CALL	CRTST		; CHECK THE STATUS
  259	  F339    20 0E          C      	JR	NZ,CRT10	; SKIP 
  260	  F33B    0B             C      	DEC	BC		; COUNT DOWN
  261	  F33C    78             C      	LD	A,B		; BC REACHED ZERO?
  262	  F33D    B1             C      	OR	C
  263	  F33E    20 F6          C      	JR	NZ,CRT20	; NO, LOOP BACK
  264	  F340    3E 00          C      	LD	A,0		; MOTOR AND LIGHT OFF
  265	  F342    D3 18          C      	OUT	(FDD),A		; SEND OUT
  266	  F344    32 F878        C      	LD	(MOTFLG),A	; MOTOR ON-OFF FLAG
  267	  F347    18 ED          C      	JR	CRT20		; LOOP UNTIL WE GET A CHARACTER
  268	  F349    DB 0D          C      CRT10:	IN	A,(SIOBD0)	; FETCH THE CHARACTER
  269	  F34B    E6 7F          C      	AND	7FH		; STRIP OFF PARITY BIT 
  270	  F34D    C1             C      	POP	BC
  271	  F34E    C9             C      	RET
  272	                         C      
  273	                         C      ; OUTPUT A CHARACTER TO THE CONSOLE.
  274	                         C      ;	ENTRY:	C=CHARACTER TO BE OUTPUT
  275	                         C      
  276	  F34F    CD F6FF        C      CONOUT:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  277	  F352    00             C      	DEFB	0		; CONSOLE POSITION IN IOBYTE
  278	  F353    F35B           C      	DEFW	TTYOUT		; CONSOLE PRINTER DEVICE
  279	  F355    F366           C      	DEFW	CRTOUT		; CONSOLE CRT DEVICE
  280	  F357    F418           C      	DEFW	BATOUT		; CONSOLE BATCH DEVICE
  281	  F359    F418           C      	DEFW	UC1OUT		; USER DEFINED CONSOLE
  282	                         C      
  283	                         C      ; OUTPUT ROUTINE FOR SERIAL EPSON AND TI PRINTER
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-8
802FCONS.MAC--CONSOLE I/O MODULE

  284	                         C      ; SIO CHANNEL A.
  285	                         C      
  286	  F35B    CD F30B        C      TTYOUT:	CALL	TTYST		; CHECK STATUS OF PRINTER
  287	  F35E    28 FB          C      	JR	Z,TTYOUT	; NOT READY, LOOP BACK
  288	  F360    79             C      	LD	A,C		; GET CHARACTER IN REG. C
  289	  F361    E6 7F          C      	AND	7FH		; STRIP OFF PARITY
  290	  F363    D3 21          C      	OUT	(SIOBD1),A	; SEND OUT
  291	  F365    C9             C      	RET
  292	                         C      
  293	                         C      ; OUTPUT ROUTINE FOR STANDARD
  294	                         C      ; CRT TERMINAL DEVICE, SIO
  295	                         C      ; CHANNEL B.
  296	                         C      
  297	  F366    DB 0F          C      CRTOUT:	IN	A,(SIOBC0)	; CHECK STATUS OF TRANSMITTER
  298	  F368    CB 57          C      	BIT	TRXRDY,A	; TRANSMITTER BUFFER EMPTY?
  299	  F36A    28 FA          C      	JR	Z,CRTOUT	; NOT YET.
  300	  F36C    79             C      	LD	A,C		; TRANSFER THE CHARACTER
  301	  F36D    D3 0D          C      	OUT	(SIOBD0),A	; OUTPUT THE CHARACTER TO SIO
  302	  F36F    C9             C      	RET
  303	                         C      
  304	                         C      ; PAPER TAPE READER ROUTINE,
  305	                         C      ; MOSTLY UNUSED.
  306	                         C      
  307	  F370    CD F6FF        C      READER:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  308	  F373    02             C      	DEFB	2		; POSITION OF READER IN IOBYTE
  309	  F374    F331           C      	DEFW	TTYIN		; STANDARD TELETYPE DEVICE
  310	  F376    F418           C      	DEFW	PTRRDR		; HIGH SPEED PAPER TAPE READER
  311	  F378    F418           C      	DEFW	UR1RDR		; USER DEFINED READER #1
  312	  F37A    F418           C      	DEFW	UR2RDR		; USER DEFINED READER #2
  313	                         C       	
  314	                         C      
  315	                         C      ; PAPER TAPE PUNCH ROUTINE,
  316	                         C      ; CURRENTLY DUMMIED OUT,
  317	                         C      ; PRETTY MUCH.
  318	                         C      
  319	  F37C    CD F6FF        C      PUNCH:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  320	  F37F    04             C      	DEFB	4		; PUNCH POSITION IN IOBYTE
  321	  F380    F35B           C      	DEFW	TTYOUT		; TELETYPE OUTPUT
  322	  F382    F418           C      	DEFW	PTPPUN		; HIGH SPEED PUNCH DEVICE
  323	  F384    F418           C      	DEFW	UP1PUN		; USER DEFINED PUNCH #1
  324	  F386    F418           C      	DEFW	UP2PUN		; USER DEFINED PUNCH #2
  325	                         C      
  326	                         C      ; SEND A CHARACTER TO THE PARALLEL PORT.
  327	                         C      ; THIS PORT HAS A STANDARD CENTRONICS INTERFACE.
  328	                         C      ;	ENTRY:		C=CHARACTER TO BE OUTPUT
  329	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-9
802FCONS.MAC--CONSOLE I/O MODULE

  330	  F388    CD F6FF        C      LIST:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  331	  F38B    06             C      	DEFB	6		; LIST POSITION IN IOBYTE
  332	  F38C    F35B           C      	DEFW	TTYOUT		; OUTPUT TO TELETYPE DEVICE
  333	  F38E    F366           C      	DEFW	CRTOUT		; OUTPUT TO CRT DEVICE
  334	  F390    F394           C      	DEFW	LPTLST		; LINE PRINTER DEVICE
  335	  F392    F3A9           C      	DEFW	UL1LST		; USER DEFINED PRINTING DEVICE
  336	                         C      
  337	                         C      ; THIS IS THE PRINTER OUTPUT ROUTINE
  338	                         C      ; FOR THE CENTRONICS PARALLEL DEVICE.
  339	                         C      
  340	  F394    CD F3F9        C      LPTLST:	CALL	LPTLSS		; CHECK STATUS
  341	  F397    20 FB          C      	JR	NZ,LPTLST	; LOOP UNTIL PRINTER READY
  342	  F399    79             C      	LD	A,C		; LOAD THE CHARACTER
  343	  F39A    D3 1D          C      	OUT	(PIOBD),A	; INTO PIO CHANNEL B DATA REG.
  344	  F39C    DB 1C          C      	IN	A,(PIOAD)	; READ PRINTER CONTROL LINES
  345	  F39E    CB 87          C      	RES	STROBE,A	; PULSE THE STROBE LINE
  346	  F3A0    D3 1C          C      	OUT	(PIOAD),A	; TO INDICATE THAT DATA IS
  347	  F3A2    DB 1C          C      	IN	A,(PIOAD)	; VALID IN CHANNEL B DATA PORT
  348	  F3A4    CB C7          C      	SET	STROBE,A	; RAISE STROBE LINE AGAIN
  349	  F3A6    D3 1C          C      	OUT	(PIOAD),A	; COMPLETE STROBE SIGNAL
  350	  F3A8    C9             C      	RET
  351	                         C      
  352	                         C      
  353	                         C       
  354	                         C      ; HERE IS THE SERIAL PRINTER DRIVER, WHICH EXPECTS
  355	                         C      ; THE DEVICE ON THE OTHER END TO SUPPORT AN ETX/ACK
  356	                         C      ; PROTOCOL.  PORT USED IS SIO CHANNEL A.
  357	                         C      
  358	  F3A9    3A F8A8        C      UL1LST:	LD	A,(UL1SIZ)	; SIZE OF PRINTER BUFFER.
  359	  F3AC    47             C      	LD	B,A		; FOR LATER.
  360	  F3AD    B7             C      	OR	A		; CLEAR CARRY
  361	  F3AE    1F             C      	RRA			; DIVIDE BY 2
  362	  F3AF    5F             C      	LD	E,A		; E <- UL1SIZ/2
  363	  F3B0    21 FA91        C      	LD	HL,UL1CNT	; CURRENT BUFFER COUNT
  364	  F3B3    34             C      	INC	(HL)		; BUMP IT.
  365	                         C       
  366	  F3B4    DB 23          C      UL1L10:	IN	A,(SIOBC1)	; READ STATUS 
  367	  F3B6    CB 47          C      	BIT	RCVRDY,A	; DO WE HAVE AN INPUT CHARACTER?
  368	  F3B8    28 08          C      	JR	Z,UL1L20	; NO. SEND CHARACTER.
  369	  F3BA    DB 21          C      	IN	A,(SIOBD1)	; GRAB THE CHARACTER.
  370	  F3BC    E6 7F          C      	AND	7FH		; STIP PARITY.
  371	  F3BE    FE 06          C      	CP	ASCACK		; IS IT ACK?
  372	  F3C0    28 22          C      	JR	Z,UL1L60	; YES, PROCESS IT.
  373	  F3C2    7B             C      UL1L20:	LD	A,E		; GET UL1SIZ/2
  374	  F3C3    BE             C      	CP	(HL)		; IS BUFFER HALF-FULL?
  375	  F3C4    20 0C          C      	JR	NZ,UL1L40	; NO, NO NEED FOR ETX.
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-10
802FCONS.MAC--CONSOLE I/O MODULE

  376	                         C       
  377	  F3C6    DB 23          C      UL1L30:	IN	A,(SIOBC1)	; PREPARE FOR OUTPUT.
  378	  F3C8    CB 57          C      	BIT	TRXRDY,A	; CAN WE OUTPUT?
  379	  F3CA    28 FA          C      	JR	Z,UL1L30	; NOT YET.
  380	  F3CC    3E 03          C      	LD	A,ASCETX	; SEND OFF THE END-OF-
  381	  F3CE    D3 21          C      	OUT	(SIOBD1),A	; BLOCK CHARACTER.
  382	  F3D0    18 06          C      	JR	UL1L50		; NOW OUTPUT THE CHARACTER
  383	                         C       
  384	  F3D2    78             C      UL1L40:	LD	A,B		; ORIGINAL BUFFER SIZE
  385	  F3D3    BE             C      	CP	(HL)		; CHECK FOR FULL AND OVERFLOW.
  386	  F3D4    28 F0          C      	JR	Z,UL1L30	; FULL, SO SEND ANOTHER ETX
  387	  F3D6    38 DC          C      	JR	C,UL1L10	; OVERFLOW, WAIT FOR ACK.
  388	                         C       
  389	  F3D8    DB 23          C      UL1L50:	IN	A,(SIOBC1)	; THIS IS THE REAL OUTPUT
  390	  F3DA    CB 57          C      	BIT	TRXRDY,A	; ROUTINE AND EXIT
  391	  F3DC    28 FA          C      	JR	Z,UL1L50	; LOOP UNTIL TRANSMITTER READY.
  392	  F3DE    79             C      	LD	A,C		; CHARACTER HAS BEEN IN REG. C
  393	  F3DF    E6 7F          C      	AND	7FH		; ALL THIS TIME. STRIP PARITY.
  394	  F3E1    D3 21          C      	OUT	(SIOBD1),A	; SHIP IT!
  395	  F3E3    C9             C      	RET			; ONLY EXIT POINT.
  396	                         C      
  397	  F3E4    7E             C      UL1L60:	LD	A,(HL)		; DID WE EVER SEND AN ETX?
  398	  F3E5    93             C      	SUB	E		; I.E., IS BUFFER > = HALF FULL?
  399	  F3E6    28 02          C      	JR	Z,UL1L70	; YES.
  400	  F3E8    38 EE          C      	JR	C,UL1L50	; NO, SPURIOUS ACK.
  401	                         C       
  402	  F3EA    77             C      UL1L70:	LD	(HL),A		; ADJUST THE BUFFER COUNT
  403	  F3EB    18 EB          C      	JR	UL1L50		; AND SEND THE CHARACTER.
  404	                         C       
  405	                         C      ; TEST THE STATUS OF THE PRINTER.
  406	                         C      ; THEN RETURN NOT READY FLAG.
  407	                         C      ;	EXIT:		A=0	->	PRINTER IS NOT READY
  408	                         C      ;			A=0FFH	->	PRINTER IS READY
  409	                         C      
  410	  F3ED    CD F6FF        C      LISTST:	CALL	IODISP		; DIRECT I/O TO PROPER DEVICE
  411	  F3F0    06             C      	DEFB	6		; LIST POSITION IN IOBYTE
  412	  F3F1    F30B           C      	DEFW	TTYST		; STATUS OF TELETYPE DEVICE
  413	  F3F3    F31C           C      	DEFW	CRTST		; STATUS OF CRT DEVICE
  414	  F3F5    F3F9           C      	DEFW	LPTLSS		; STATUS OF LINE PRINTER DEVICE
  415	  F3F7    F404           C      	DEFW	UL1LSS		; STATUS OF USER DEFINED PRINTING DEVICE
  416	                         C      
  417	                         C      
  418	                         C      ; PARALLEL PRINTER STATUS CHECK.
  419	                         C      ; RETURNS PRINTER NOT READY BECAUSE:
  420	                         C      ; 1) IT IS OUT OF PAPER
  421	                         C      ; 2) IT IS BUSY
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-11
802FCONS.MAC--CONSOLE I/O MODULE

  422	                         C      ; 3) A FAULT OCCURED
  423	                         C       
  424	  F3F9    DB 1C          C      LPTLSS:	IN	A,(PIOAD)	; READ PRINTER STATUS
  425	                         C      ;	AND	PIOMSK		; MASK OFF DON'T CARE BITS
  426	                         C      ;	XOR	PIOERR		; ERROR MASK, PRINTER READY?
  427	                         C      ;	JR	NZ,LPTS10	; NO.
  428	                         C      ;	DEC	A		; YES, RETURN FF IN A
  429	                         C      
  430	  F3FB    CB 6F          C      	BIT	PRTBSY,A	; TEST PRINTER BUSY BIT
  431	  F3FD    3E 00          C      	LD	A,0
  432	  F3FF    C0             C      	RET	NZ
  433	  F400    2F             C      	CPL			; SET A = FFH AND ZERO FLAG = 1
  434	  F401    C9             C      	RET
  435	                         C      
  436	  F402    AF             C      LPTS10:	XOR	A		; INDICATE NOT READY
  437	  F403    C9             C      	RET			; BY RETURNING 0 IN A
  438	                         C      
  439	                         C      ; CHECK THE STATUS OF SERIAL PRINTER,
  440	                         C      ; CP/M UL1 DEVICE.
  441	                         C      
  442	  F404    21 FA91        C      UL1LSS:	LD	HL,UL1CNT	; CURRENT BUFFER COUNT
  443	  F407    3A F8A8        C      	LD	A,(UL1SIZ)	; MAX COUNT.
  444	  F40A    BE             C      	CP	(HL)		; ROOM FOR MORE CHARACTER?
  445	  F40B    3E FF          C      	LD	A,0FFH		; ANTICIPATE AFFIRMATIVE.
  446	  F40D    C0             C      	RET	NZ		; LISTER IS READY.
  447	                         C       
  448	  F40E    DB 23          C      	IN	A,(SIOBC1)	; OTHERWISE SEE IF WE HAVE
  449	  F410    CB 47          C      	BIT	RCVRDY,A	; AN INPUT CHARACTER READY.
  450	  F412    3E FF          C      	LD	A,0FFH		; ANTICIPATE AFFIRMATIVE AGAIN.
  451	  F414    C0             C      	RET	NZ		; WE ARE ASSUMING CHAR. IS AN ACK.
  452	                         C       
  453	  F415    AF             C      	XOR	A		; WE MUST NOT BE READY YET
  454	  F416    C9             C      	RET
  455	                         C      
  456	                         C      ; FOLLOWING IS JUST A GENERAL-PURPOSE
  457	                         C      ; DUMMY ROUTINE, USED FOR UNDEFINED BIOS
  458	                         C      ; HOOKS, AND UNUSED IOBYTE DRIVERS.
  459	                         C      
  460	  F417    C9             C      UNUSED:	RET			; JUST RETURN FOR NOW
  461	                         C      
  462	                         C      ; PAPER TAPE READER, PUNCH AND CONSOLE
  463	                         C      ; DUMMY ROUTINES.  USER MAY FILL OUT LATER.
  464	                         C      
  465	  F418                   C      BATIN:
  466	  F418                   C      UC1IN:
  467	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-12
802FCONS.MAC--CONSOLE I/O MODULE

  468	  F418                   C      BATOUT:
  469	  F418                   C      UC1OUT:
  470	                         C      
  471	  F418                   C      PTRRDR:
  472	  F418                   C      UR1RDR:
  473	  F418                   C      UR2RDR:
  474	                         C      
  475	  F418                   C      PTPPUN:
  476	  F418                   C      UP1PUN:
  477	  F418                   C      UP2PUN:
  478	                         C      
  479	  F418    3E 1A          C      	LD	A,1AH		; RETURN EOF.
  480	  F41A    C9             C      	RET
  481	                         C      
  482	                         C      ; DUMMY CONSOLE STATUS ROUTINES 
  483	                         C      
  484	  F41B                   C      BATST:
  485	  F41B                   C      UC1ST:
  486	  F41B    AF             C      	XOR	A		; ALWAYS BUSY
  487	  F41C    C9             C      	RET
  488	                         C      
  489	                         C      ; END OF 802FCONS.MAC
  490	                                
  491	                                	SUBTTL 802FDISK.MAC--DISK I/O MODULE
  492	                                	PAGE
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-13
802FDISK.MAC--DISK I/O MODULE

  493	                                
  494	                         C      	INCLUDE 802FDISK.MAC
  495	                         C      
  496	                         C      ; HOME THE HEADS TO TRACK 0
  497	                         C      
  498	  F41D    3A F984        C      HOME:	LD	A,(HSTWRT)	; CHECK WRITE PENDING DATA IN BUFFER
  499	  F420    B7             C      	OR	A
  500	  F421    20 03          C      	JR	NZ,HOMED	; IF WRITE DATA PENDING THEN SKIP
  501	                         C      
  502	  F423    32 F983        C      	LD	(HSTACT),A
  503	                         C      
  504	  F426    AF             C      HOMED:	XOR	A
  505	  F427    32 F97D        C      	LD	(SEKTRK),A	; RESET SEEK TRACK TO ZERO
  506	  F42A    C9             C      	RET
  507	                         C      
  508	                         C      ; DISK SELECT ENTRY ROUTINE
  509	                         C      ; ACCEPTS: C = DRIVE SELECT (WITH C=0 FOR SELECT DRIVE"A")
  510	                         C      ; RETURNS: HL = DPB POINTER OF DRIVE SELECT (IF C=VALID DRIVE NUMBER)
  511	                         C      ;          HL = 0H IF (C=INVALID DRIVE NUMBER)
  512	                         C      
  513	  F42B    21 0000        C      SELDSK:	LD	HL,0		; SET HL = ERROR RETURN CODE
  514	  F42E    79             C      	LD	A,C
  515	  F42F    32 F97C        C      	LD	(SEKDSK),A	; SAVE DRIVE NUMBER
  516	  F432    FE 02          C      	CP	MAXDRV+1	; CHECK FOR VALID DRIVE
  517	  F434    D0             C      	RET	NC		; EXIT WITH HL = 0H
  518	                         C      
  519	                         C      ; DRIVE NUMBER IS IN PROPER RANGE
  520	                         C      
  521	  F435    6F             C      	LD	L,A
  522	  F436    26 00          C      	LD	H,0
  523	  F438    29             C      	ADD	HL,HL
  524	  F439    29             C      	ADD	HL,HL
  525	  F43A    29             C      	ADD	HL,HL
  526	  F43B    29             C      	ADD	HL,HL		; MULTIPLY BY 16
  527	  F43C    11 F879        C      	LD	DE,DPBASE	; BASE OF PARAMETER BLOCK
  528	  F43F    19             C      	ADD	HL,DE		; HL=.DPB(CURDSK)
  529	  F440    C9             C      	RET
  530	                         C      
  531	                         C      ; SETTRK -- SET READ/WRITE TRACK
  532	                         C      ; ACCEPTS: C = TRACK NUMBER
  533	                         C      
  534	  F441    79             C      SETTRK:	LD	A,C
  535	  F442    32 F97D        C      	LD	(SEKTRK),A
  536	  F445    C9             C      	RET
  537	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-14
802FDISK.MAC--DISK I/O MODULE

  538	                         C      ; SETSEC -- SET READ/WRITE SECTOR
  539	                         C      ; ACCEPTS: C = SECTOR NUMBER
  540	                         C      
  541	  F446    79             C      SETSEC:	LD	A,C
  542	  F447    32 F97E        C      	LD	(SEKSEC),A
  543	  F44A    C9             C      	RET
  544	                         C      
  545	                         C      ; SETDMA -- SET READ/WRITE DMA BUFFER ADDRESS
  546	                         C      
  547	  F44B    ED 43 F98D     C      SETDMA:	LD	(DMAADR),BC
  548	  F44F    C9             C      	RET
  549	                         C      
  550	                         C      ; SECTRAN -- TRANSLATE SECTOR
  551	                         C      ; ACCEPTS: BC = LOGICAL SECTOR
  552	                         C      ;	   DE = TRANSLATIN TABLE ADDRESS	
  553	                         C      ; RETURNS: HL = PHYSICAL SECTOR
  554	                         C      
  555	  F450    60             C      SECTRN:	LD	H,B
  556	  F451    69             C      	LD	L,C
  557	  F452    C9             C      	RET
  558	                         C      
  559	                         C      ; READ CP/M SECTOR ENTRY POINT
  560	                         C      ; THIS ROUTINE READ THE SELECTED CP/M SECTOR
  561	                         C      ; INTO SELECTED DMA BUFFER POINTER
  562	                         C      
  563	  F453    AF             C      READ:	XOR	A	
  564	  F454    32 F985        C      	LD	(UNACNT),A
  565	  F457    3E 01          C      	LD	A,1
  566	  F459    32 F98B        C      	LD	(READOP),A		; SET READ OPERATION
  567	  F45C    32 F98A        C      	LD	(RSFLAG),A		; MUST READ DATA
  568	  F45F    3E 02          C      	LD	A,WRUAL
  569	  F461    32 F98C        C      	LD	(WRTYPE),A		; TREAT AS UNALLOC
  570	  F464    C3 F4CC        C      	JP	RDWTCM			; PERFORM THE READ
  571	                         C      
  572	                         C      ; WRITE ROUTINE ENTRY POINT
  573	                         C      ; THIS ROUTINE WRITE THE SELECTED DMA BUUFER POINTER
  574	                         C      ; INTO SELECTED CP/M SECTOR
  575	                         C      
  576	  F467    AF             C      WRITE:	XOR	A
  577	  F468    32 F98B        C      	LD	(READOP),A	; SET OPERATION TO WRITE
  578	  F46B    79             C      	LD	A,C		; SAVE WRITE TYPE
  579	  F46C    32 F98C        C      	LD	(WRTYPE),A
  580	  F46F    FE 02          C      	CP	WRUAL		; WRITE UNALLOCATED?
  581	  F471    20 17          C      	JR	NZ,WRIT10	; CHECK FOR UNALLOC
  582	                         C      
  583	                         C      ; WRITING TO AN UNALLOCATED BLOCK
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-15
802FDISK.MAC--DISK I/O MODULE

  584	                         C      
  585	  F473    3E 10          C      	LD	A,BLKSIZ/128	; NUMBER OF SECTORS/BLOCK
  586	  F475    32 F985        C      	LD	(UNACNT),A	; UNALLOCATED SECTORS REMAINING
  587	  F478    3A F97C        C      	LD	A,(SEKDSK)	; CP/M DRIVE.
  588	  F47B    32 F986        C      	LD	(UNADSK),A	; TO UNALLOCATED DISK
  589	  F47E    3A F97D        C      	LD	A,(SEKTRK)	; CP/M TRACK NO.
  590	  F481    32 F987        C      	LD	(UNATRK),A
  591	  F484    3A F97E        C      	LD	A,(SEKSEC)	; CP/M SECTOR NO.
  592	  F487    32 F988        C      	LD	(UNASEC),A
  593	                         C      
  594	                         C      ; CHECK FOR WRITE TO UNALLOCATED SECTOR
  595	                         C      
  596	  F48A    3A F985        C      WRIT10:	LD	A,(UNACNT)	; ANY UNALLOCATED SECTOR REMAIN?
  597	  F48D    B7             C      	OR	A
  598	  F48E    28 34          C      	JR	Z,WRIT30	; SKIP IF NOT
  599	                         C      
  600	                         C      ; MORE UNALLOCATED SECTORS IN THIS BLOCK
  601	                         C      
  602	  F490    3D             C      	DEC	A		; UNACNT = UNACNT-1
  603	  F491    32 F985        C      	LD	(UNACNT),A
  604	  F494    3A F97C        C      	LD	A,(SEKDSK)	; GET SEEK DISK INTO A
  605	  F497    21 F986        C      	LD	HL,UNADSK
  606	  F49A    BE             C      	CP	(HL)		; SEEK.DSK = UNALL.DSK?
  607	  F49B    20 27          C      	JR	NZ,WRIT30	; SKIP IF NOT
  608	                         C      
  609	                         C      ; DISKS ARE THE SAME
  610	                         C      
  611	  F49D    3A F97D        C      	LD	A,(SEKTRK)	;  CP/M TRACK NO.	
  612	  F4A0    21 F987        C      	LD	HL,UNATRK	;  UNALLOCATED TRACK NO.
  613	  F4A3    BE             C      	CP	(HL)		; SEEK.TRK = UNALL.TRK?
  614	  F4A4    20 1E          C      	JR	NZ,WRIT30	; SKIP IF NOT
  615	                         C      
  616	                         C      ; TRACKS ARE THE SAME
  617	                         C      
  618	  F4A6    3A F97E        C      	LD	A,(SEKSEC)	; GET SEEK SECTOR INTO A
  619	  F4A9    21 F988        C      	LD	HL,UNASEC
  620	  F4AC    BE             C      	CP	(HL)		; SEEK.SEC = UNALL.SEC?
  621	  F4AD    20 15          C      	JR	NZ,WRIT30	; SKIP IF NOT
  622	                         C      
  623	                         C      ; MATCH, MOVE "UNASEC" TO NEXT SECTOR FOR FUTURE REF.
  624	                         C      
  625	  F4AF    34             C      	INC	(HL)		; UNASEC = UNASEC+1
  626	  F4B0    7E             C      	LD	A,(HL)
  627	  F4B1    FE 48          C      	CP	CPMSPT		; CHECK END OF SECTOR IN CUR.TRACK?
  628	  F4B3    38 09          C      	JR	C,WRIT20	; SKIP IF NO OVERFLOW
  629	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-16
802FDISK.MAC--DISK I/O MODULE

  630	                         C      ; OVERFLOW TO NEXT TRACK
  631	                         C      
  632	  F4B5    36 00          C      	LD	(HL),0		; RESET SECTOR
  633	  F4B7    3A F987        C      	LD	A,(UNATRK)
  634	  F4BA    3C             C      	INC	A
  635	  F4BB    32 F987        C      	LD	(UNATRK),A	; UNATRK = UNATRK+1
  636	                         C      
  637	                         C      ; MATCH FOUND, MARK AS UNNECESSARY READ
  638	                         C      
  639	  F4BE    AF             C      WRIT20:	XOR	A
  640	  F4BF    32 F98A        C      	LD	(RSFLAG),A	; SET PRE-READ FLAG = NO
  641	  F4C2    18 08          C      	JR	RDWTCM		; PERFORM WRITE CP/M SECTOR
  642	                         C      
  643	                         C      ; NOT AN UNALLOCATED SECTOR, REQUIRES PRE-READ
  644	                         C      
  645	  F4C4    AF             C      WRIT30:	XOR	A
  646	  F4C5    32 F985        C      	LD	(UNACNT),A	; RESET UNALLOC. COUNTER = 0
  647	  F4C8    3C             C      	INC	A
  648	  F4C9    32 F98A        C      	LD	(RSFLAG),A	; SET PRE-READ FLAG = YES.
  649	                         C      
  650	                         C      ; COMMON CODE FOR READ AND WRITE ROUTINE
  651	                         C      
  652	  F4CC    AF             C      RDWTCM:	XOR	A
  653	  F4CD    32 F989        C      	LD	(ERFLAG),A	; RESET ERROR FLAG
  654	  F4D0    3A F97E        C      	LD	A,(SEKSEC)	; CONVERT SEEEK SECTOR TO HOST SECTOR
  655	  F4D3    B7             C      	OR	A		; CLEAR CARRY FLAG
  656	  F4D4    1F             C      	RRA
  657	  F4D5    32 F982        C      	LD	(SEKHST),A	; TEMPORARY SECTOR NO.
  658	                         C      
  659	                         C      ; ACTIVE HOST SECTOR?
  660	                         C      
  661	  F4D8    21 F983        C      	LD	HL,HSTACT
  662	  F4DB    7E             C      	LD	A,(HL)
  663	  F4DC    36 01          C      	LD	(HL),1		; ALWAY BECOMES 1
  664	  F4DE    B7             C      	OR	A
  665	  F4DF    28 25          C      	JR	Z,RDWT20	; FILL BUFFER IN ACTIVE FLAG = 0
  666	                         C      
  667	                         C      ; HOST BUFFER ACTIVE, SAME AS SEEK BUFFER?
  668	                         C      
  669	  F4E1    3A F97C        C      	LD	A,(SEKDSK)
  670	  F4E4    21 F97F        C      	LD	HL,HSTDSK
  671	  F4E7    BE             C      	CP	(HL)		; SAME DISK?
  672	  F4E8    20 12          C      	JR	NZ,RDWT10	; SKIP IF NOT MATCH
  673	                         C      
  674	                         C      ; SAME DISK, SAME TRACK?
  675	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-17
802FDISK.MAC--DISK I/O MODULE

  676	  F4EA    3A F97D        C      	LD	A,(SEKTRK)
  677	  F4ED    21 F980        C      	LD	HL,HSTTRK
  678	  F4F0    BE             C      	CP	(HL)		; SAME TRACK?
  679	  F4F1    20 09          C      	JR	NZ,RDWT10	; SKIP IF NOT MATCH
  680	                         C      
  681	                         C      ; SAME DISK, SAME TRACK, SAME BUFFER?
  682	                         C      
  683	  F4F3    3A F982        C      	LD	A,(SEKHST)
  684	  F4F6    21 F981        C      	LD	HL,HSTSEC
  685	  F4F9    BE             C      	CP	(HL)
  686	  F4FA    28 2A          C      	JR	Z,RDWT40	; SKIP IF MATCH
  687	                         C      
  688	                         C      ; PROPER DISK, BUT NOT CORRECT SECTOR
  689	                         C      
  690	  F4FC    3A F984        C      RDWT10:	LD	A,(HSTWRT)	; WRITE DATA PENDING IN BUFFER?
  691	  F4FF    B7             C      	OR	A
  692	  F500    28 04          C      	JR	Z,RDWT20	; NO NEED TO FLUSH BUFFER
  693	  F502    CD F566        C      	CALL	WRITEHST	; IF YES, THEN WRITE DATA TO DISK
  694	  F505    C0             C      	RET	NZ		; ERROR IN WRITING TO DISK.
  695	                         C      
  696	                         C      ; MAY HAVE TO PRE-READ DATA TO HOST BUFFER
  697	                         C      
  698	  F506    3A F97C        C      RDWT20:	LD	A,(SEKDSK)
  699	  F509    32 F97F        C      	LD	(HSTDSK),A
  700	  F50C    3A F97D        C      	LD	A,(SEKTRK)
  701	  F50F    32 F980        C      	LD	(HSTTRK),A
  702	  F512    3A F982        C      	LD	A,(SEKHST)
  703	  F515    32 F981        C      	LD	(HSTSEC),A
  704	  F518    3A F98A        C      	LD	A,(RSFLAG)	; CHECK BUFFER REQUIRES PRE-READ
  705	  F51B    B7             C      	OR	A
  706	  F51C    28 04          C      	JR	Z,RDWT30	; NO PRE-READ REQUIRED
  707	  F51E    CD F55F        C      	CALL	READHST		; IF YES, THEN READ DATA FROM DISK
  708	  F521    C0             C      	RET	NZ		; ERROR IN READING
  709	                         C      
  710	  F522    AF             C      RDWT30:	XOR	A		; INTO BUFFER.
  711	  F523    32 F984        C      	LD	(HSTWRT),A	; RESET PENDING WRITE FLAG
  712	                         C      
  713	                         C      ; COPY DATA TO OR FROM BUFFER
  714	                         C      
  715	  F526    3A F97E        C      RDWT40:	LD	A,(SEKSEC)	; COMPUTE RELATIVE HOST BUFFER ADDRESS
  716	  F529    E6 01          C      	AND	SECMSK
  717	  F52B    67             C      	LD	H,A
  718	  F52C    2E 00          C      	LD	L,0
  719	  F52E    CB 3C          C      	SRL	H
  720	  F530    CB 1D          C      	RR	L		; HL = ((SEKSEC)&SECMSK)*128
  721	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-18
802FDISK.MAC--DISK I/O MODULE

  722	                         C      ; HL HAS RELATIVE HOST BUFFER ADDRESS
  723	                         C      
  724	  F532    11 F991        C      	LD	DE,HSTBUF
  725	  F535    19             C      	ADD	HL,DE
  726	  F536    ED 5B F98D     C      	LD	DE,(DMAADR)	; GET/PUT CP/M DATA BUFFER POINTER
  727	  F53A    01 0080        C      	LD	BC,128		; SET BC = LENGTH TO MOVE
  728	  F53D    3A F98B        C      	LD	A,(READOP)	; WHICH WAY?
  729	  F540    B7             C      	OR	A
  730	  F541    20 06          C      	JR	NZ,RDWT50	; SKIP IF READ OPERATION
  731	                         C      
  732	                         C      ; WRITE OPERATION, MARK AND SWITCH DIRECTION
  733	                         C      
  734	  F543    3E 01          C      	LD	A,1
  735	  F545    32 F984        C      	LD	(HSTWRT),A	; SET WRITE PENDING FLAG ON
  736	  F548    EB             C      	EX	DE,HL		; SOURCE/DESTINATION POINTERS SWAP
  737	                         C      
  738	                         C      ; BC INITIALLY 128, DE DESTINATION, HL IS SOURCE POINTER
  739	                         C      
  740	  F549    ED B0          C      RDWT50:	LDIR
  741	                         C      
  742	                         C      ; DATA HAS BEEN MOVE TO/FROM HOST BUFFER
  743	                         C      
  744	  F54B    3A F98C        C      	LD	A,(WRTYPE)	; CHECK WRITE TYPE OPERATION
  745	  F54E    FE 01          C      	CP	WRDIR		; DIRECTORY WRITE?
  746	  F550    28 05          C      	JR	Z,RDWT60	; IF NOT A DIRECTORY WRITE THEN EXIT
  747	  F552    3A F989        C      	LD	A,(ERFLAG)	; WITH ERROR FLAG =0, AND Z=1
  748	  F555    B7             C      	OR	A
  749	  F556    C9             C      	RET
  750	                         C      
  751	                         C      ; ALWAYS FLUSH A DIRECTORY BUFFER
  752	                         C      
  753	  F557    AF             C      RDWT60:	XOR	A
  754	  F558    32 F984        C      	LD	(HSTWRT),A	; RESET WRITE PENDING FLAG
  755	  F55B    CD F566        C      	CALL	WRITEHST
  756	  F55E    C9             C      	RET
  757	                         C      
  758	                         C      ; HERE ARE THE SECTOR READ/WRITE FUNCTIONS. WE
  759	                         C      ; WANT TO READ/WRITE TO DISK USING THE PARAMETERS
  760	                         C      ; SECTOR, TRACK, DMA ADDRESS.
  761	                         C      
  762	  F55F                   C      READHST:
  763	  F55F    3E 80          C      	LD	A,RDSCMD	; FDC READ COMMAND
  764	  F561    21 F77F        C      	LD	HL,RDSTAB	; DMA INITIALIZATION TABLE
  765	  F564    18 05          C      	JR	RWHSEC		; CODE COMMON TO READ AND WRITE
  766	                         C      
  767	  F566                   C      WRITEHST:
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-19
802FDISK.MAC--DISK I/O MODULE

  768	  F566    3E A0          C      	LD	A,WTSCMD	; FDC WRITE COMMAND
  769	  F568    21 F790        C      	LD	HL,WTSTAB	; DMA INITIALIZATION TABLE FOR WRITE
  770	                         C      
  771	  F56B    32 F975        C      RWHSEC:	LD	(COMAND),A
  772	  F56E    22 F97A        C      	LD	(DMATAB),HL
  773	                         C      
  774	  F571    3A F97F        C      	LD	A,(HSTDSK)
  775	  F574    21 F876        C      	LD	HL,DRIVE	; CURRENT DRIVE
  776	  F577    BE             C      	CP	(HL)		; SAME DRIVE?
  777	  F578    C4 F693        C      	CALL	NZ,SELDRV	; NO, HARDWARE SELECT THE DRIVE 
  778	  F57B    CD F662        C      	CALL	SELSID		; SELECT THE PROPER SIDE	
  779	                         C      
  780	                         C      ; READY TO READ OR WRITE A PHYSICAL SECTOR
  781	                         C      
  782	  F57E    3E 0A          C      	LD	A,10		; NO. OF RETRIES
  783	  F580    32 F977        C      	LD	(RETRY),A	; ON DISK I/O OPERATION
  784	                         C      
  785	  F583    2A F97A        C      RWHS10:	LD	HL,(DMATAB)	; GET DMA INITIALIZE PARAMETER POINTER
  786	  F586    CD F6EE        C      	CALL	PRTINI		; DO DMA INITIALIZATION.
  787	  F589    CD F5BB        C      	CALL	SEEK		; SEEK THE USER DEFINED TRACK
  788	  F58C    20 0F          C      	JR	NZ,RWHS20	; ADJUST RETRY COUNTER
  789	  F58E    3A F975        C      	LD	A,(COMAND)	; SET UP FDC
  790	  F591    D3 14          C      	OUT	(FDCCMD),A	; COMMAND REGISTER
  791	  F593    CD F5DB        C      	CALL	WAIT		; WAIT FOR CONTROLLER NOT BUSY
  792	  F596    20 05          C      	JR	NZ,RWHS20	; ERROR ON READ/WRITE
  793	  F598    3A F989        C      	LD	A,(ERFLAG)	; RETURN CODE
  794	  F59B    B7             C      	OR	A		; SET/CLEAR Z FLAG
  795	  F59C    C9             C      	RET			; DISK I/O SUCCESSFUL
  796	                         C      
  797	                         C      ; WE HAD AN ERROR ON READ/WRITE OPERATION
  798	                         C      
  799	  F59D    CD F6D9        C      RWHS20:	CALL	RESDMA		; RESET THE DMA ON ABORT
  800	  F5A0    3A F989        C      	LD	A,(ERFLAG)	; IF DRIVE NOT READY,
  801	  F5A3    CB 7F          C      	BIT	FDCRDY,A	; DON'T BOTHER WITH RETRIES
  802	  F5A5    C0             C      	RET	NZ		; RETURN ERROR FLAG IN A
  803	                         C      
  804	  F5A6    21 F977        C      	LD	HL,RETRY	; MORE RETRIES LEFT?
  805	  F5A9    7E             C      	LD	A,(HL)
  806	  F5AA    35             C      	DEC	(HL)		; BUMP DOWN COUNT
  807	  F5AB    B7             C      	OR	A
  808	  F5AC    28 05          C      	JR	Z,RWHS30	; ALL DONE, WE FAILED.
  809	  F5AE    CD F6C5        C      	CALL	RESTOR		; SEEK TRACK 0.
  810	  F5B1    18 D0          C      	JR	RWHS10		; LOOP BACK FOR ANOTHER SHOT.
  811	                         C      
  812	  F5B3    CD F71A        C      RWHS30:	CALL	ERRPRT		; PRINT DETAILED ERROR MESSAGE
  813	  F5B6    3A F989        C      	LD	A,(ERFLAG)	; RETURN ERROR
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-20
802FDISK.MAC--DISK I/O MODULE

  814	  F5B9    B7             C      	OR	A		; SET/CLEAR Z FLAG.
  815	  F5BA    C9             C      	RET
  816	                         C      
  817	                         C      
  818	                         C      ; END OF 802FDISK.MAC
  819	                                
  820	                                	SUBTTL 802FSUBS.MAC--SUBROUTINES MODULE
  821	                                	PAGE
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-21
802FSUBS.MAC--SUBROUTINES MODULE

  822	                                
  823	                         C      	INCLUDE 802FSUBS.MAC
  824	                         C      
  825	                         C      ; THIS ROUTINE DOES THE ACTUAL SEEKING.
  826	                         C      
  827	  F5BB    21 F98F        C      SEEK:	LD	HL,TRKTAB	; CURRENT TRACK TABLE
  828	  F5BE    3A F97F        C      	LD	A,(HSTDSK)	; CURRENT DRIVE
  829	  F5C1    4F             C      	LD	C,A		; MAKE IT AN INDEX INTO
  830	  F5C2    06 00          C      	LD	B,0		; TRACK TABLE
  831	  F5C4    09             C      	ADD	HL,BC		; ADD IN INDEX
  832	  F5C5    7E             C      	LD	A,(HL)		; PULL OUT THE TRACK FOR THIS DRIVE
  833	  F5C6    D3 15          C      	OUT	(FDCTRK),A	; SEND IT TO THE CONTROLLER
  834	  F5C8    47             C      	LD	B,A		; SAVE FOR LATER
  835	  F5C9    3A F980        C      	LD	A,(HSTTRK)	; GET THE SOUGHT-AFTER TRACK.
  836	  F5CC    77             C      	LD	(HL),A		; PLACE IT IN TRACK TABLE
  837	  F5CD    B8             C      	CP	B		; SAME TRACK?
  838	  F5CE    C8             C      	RET	Z		; YES, NO NEED TO SEEK
  839	  F5CF    D3 17          C      	OUT	(FDCDAT),A	; AND GIVE IT TO THE CONTROLLER.
  840	  F5D1    3E 14          C      	LD	A,SEECMD	; THIS IS THE SEEK COMMAND
  841	  F5D3    D3 14          C      	OUT	(FDCCMD),A	; GIVE THE ORDER TO FDC
  842	                         C      
  843	                         C      ; NOW TEST FOR COMPLETION
  844	                         C      
  845	  F5D5    CD F5DB        C      	CALL	WAIT		; WAIT UNTIL NOT BUSY
  846	  F5D8    E6 98          C      	AND	SEEMSK		; AND OUT TRACK 0 BIT
  847	  F5DA    C9             C      	RET			; MAY HAVE FAILED
  848	                         C      
  849	                         C      ; THIS ROUTINE LOOPS UNTIL THE FDC IS
  850	                         C      ; IN A NON-BUSY STATE, OR UNTIL A NOT-
  851	                         C      ; READY CONDITION IS DETECTED.  TIME-OUT
  852	                         C      ; FOR DRIVE BUSY OCCURS AT APPROX.
  853	                         C      ; 1.5 SECONDS AFTER COMMAND
  854	                         C      ; INITIATION.
  855	                         C      
  856	  F5DB    3E 0F          C      WAIT:	LD	A,15		; WE MUST DELAY ABOUT
  857	  F5DD    3D             C      WAIT10:	DEC	A		; 60 USECS. BEFORE READING 
  858	  F5DE    20 FD          C      	JR	NZ,WAIT10	; THE STATUS.
  859	                         C      
  860	  F5E0    ED 43 F86F     C      	LD	(TEMPBC),BC	; SAVE REGISTERS
  861	  F5E4    ED 53 F871     C      	LD	(TEMPDE),DE
  862	  F5E8    22 F873        C      	LD	(TEMPHL),HL
  863	  F5EB    01 C000        C      	LD	BC,0C000H	; TIME OUT FOR 1.25 SECONDS
  864	  F5EE    3E 00          C      	LD	A,0
  865	  F5F0    32 F875        C      	LD	(JMPSW),A	; RESET THE FLAG FOR MESSAGE
  866	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-22
802FSUBS.MAC--SUBROUTINES MODULE

  867	  F5F3    DB 14          C      WAIT20:	IN	A,(FDCCMD)	; READ THE FDC STATUS--2.75
  868	  F5F5    32 F989        C      	LD	(ERFLAG),A	; SAVE IT FOR LATER--3.25
  869	  F5F8    CB 7F          C      	BIT	FDCRDY,A	; IS THE DEVICE NOT READY?--2.00
  870	  F5FA    20 1B          C      	JR	NZ,WAIT50	; YES, THIS IS AN ERROR--1.25
  871	                         C      
  872	  F5FC    F5             C      	PUSH	AF		; SAVE REGISTERS--2.75
  873	  F5FD    3A F875        C      	LD	A,(JMPSW)	; GET MESSAGE FLAG--3.25
  874	  F600    FE 00          C      	CP	0		; MESSAGE ALREADY SENT OUT?--1.75
  875	  F602    20 1F          C      	JR	NZ,WAIT30	; YES, SKIP--1.75
  876	  F604    0B             C      	DEC	BC		; COUNT DOWN--1.50
  877	  F605    78             C      	LD	A,B		; --2.25
  878	  F606    B1             C      	OR	C		; TIME OUT?--1.00
  879	  F607    CC F64E        C      	CALL	Z,SIGMSG	; YES, PRINT MESSAGE--2.50
  880	  F60A    F1             C      WAIT40:	POP	AF		; RESTORE REGISTERS--2.50
  881	                         C      
  882	  F60B    CB 47          C      	BIT	FDCBSY,A	; ARE WE PROCESSING A COMMAND?--2.00
  883	  F60D    20 E4          C      	JR	NZ,WAIT20	; NO, RETURN ERROR CODE--3.00
  884	                         C      
  885	  F60F    32 F979        C      	LD	(UNMSTA),A	; UNMASKED STATUS (FOR DEBUG)
  886	  F612    E6 DC          C      	AND	ERRMSK		; MASK OFF NON-ERROR BITS
  887	  F614    32 F989        C      	LD	(ERFLAG),A	; SAVE STATUS FOR LATER
  888	                         C      
  889	  F617    2A F873        C      WAIT50:	LD	HL,(TEMPHL)	; RESTORE REGISTERS
  890	  F61A    ED 5B F871     C      	LD	DE,(TEMPDE)
  891	  F61E    ED 4B F86F     C      	LD	BC,(TEMPBC)
  892	  F622    C9             C      	RET
  893	                         C      
  894	  F623    CD F2FF        C      WAIT30:	CALL	CONST		; CONSOLE STATUS
  895	  F626    FE 00          C      	CP	0		; AVAILABLE INPUT?
  896	  F628    28 E0          C      	JR	Z,WAIT40	; NO, SKIP
  897	  F62A    CD F325        C      	CALL	CONIN		; GET CHARACTER
  898	  F62D    FE 03          C      	CP	03H		; CONTROL-C?
  899	  F62F    20 D9          C      	JR	NZ,WAIT40	; NO, LOOP BACK
  900	                         C      
  901	  F631    F1             C      	POP	AF		; RESTORE REGISTERS
  902	  F632    2A F873        C      	LD	HL,(TEMPHL)
  903	  F635    ED 5B F871     C      	LD	DE,(TEMPDE)
  904	  F639    ED 4B F86F     C      	LD	BC,(TEMPBC)
  905	                         C      
  906	  F63D    3E D0          C      	LD	A,FRCCMD	; FORCE TERMINATE
  907	  F63F    D3 14          C      	OUT	(FDCCMD),A
  908	  F641    D3 14          C      	OUT	(FDCCMD),A
  909	  F643    CD F6D9        C      	CALL	RESDMA		; RESET DMA
  910	  F646    3E 00          C      	LD	A,0
  911	  F648    32 0004        C      	LD	(DEFDSK),A	; SET DEFAULT DRIVE TO A
  912	  F64B    C3 F280        C      	JP	WBOOT		; WARM-BOOT
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-23
802FSUBS.MAC--SUBROUTINES MODULE

  913	                         C      
  914	                         C      ; THIS ROUTINE PRINTS DOOR MESSAGE WHEN THERE IS AN ACCESS TO
  915	                         C      ; A DRIVE WITH DOOR OPENED
  916	                         C      
  917	  F64E    3E 01          C      SIGMSG:	LD	A,1		; SET FLAG
  918	  F650    32 F875        C      	LD	(JMPSW),A
  919	  F653    3A F97F        C      	LD	A,(HSTDSK)	; CURRENT DRIVE
  920	  F656    C6 41          C      	ADD	A,41H		; MAKE IT ASCII
  921	  F658    32 F855        C      	LD	(VDRIVE),A	; SAVE FOR LATER
  922	  F65B    21 F83A        C      	LD	HL,RDYMSG	; PRINT DOOR MESSAGE
  923	  F65E    CD F6E4        C      	CALL	PRTMSG
  924	  F661    C9             C      	RET
  925	                         C      
  926	                         C      ; SELECT THE PROPER SIDE OF THE
  927	                         C      ; DISKETTE TO SEEK, DEPENDING ON
  928	                         C      ; THE LOGICAL SECTOR NO. IN HSTSEC.
  929	                         C      ; GO AHEAD AND SET THE FDC SECTOR
  930	                         C      ; REGISTER.
  931	                         C      
  932	  F662    3A F976        C      SELSID:	LD	A,(FDDBYT)	; GET THE DRIVE SELECT LATCH IN MEMORY
  933	  F665    4F             C      	LD	C,A		; HOLD IT IN C FOR A BIT.
  934	  F666    CB 91          C      	RES	2,C		; CHOOSE SIDE 0, FOR NOW.
  935	  F668    3A F981        C      	LD	A,(HSTSEC)	; GET THE LOGICAL HOST SECTOR 
  936	  F66B    FE 12          C      	CP	PSPT0		; SECTOR >= THAN MAXIMUM SECTOR?
  937	  F66D    38 04          C      	JR	C,SELS10	; IF NOT THEN SELECT SIDE 0
  938	  F66F    CB D1          C      	SET	2,C		; CHOOSE SIDE 1.
  939	  F671    D6 12          C      	SUB	PSPT0		; DE-BIAS SECTOR NO.
  940	                         C      
  941	  F673    3C             C      SELS10:	INC	A		; PHYSICAL SECTORS HAVE ORIGIN 1
  942	  F674    D3 16          C      	OUT	(FDCSEC),A	; SEND SECTOR TO CONTROLLER
  943	  F676    32 F877        C      	LD	(TSEC),A	; SAVE FOR LATER
  944	  F679    79             C      	LD	A,C		; GET NEW SIDE.
  945	  F67A    32 F976        C      	LD	(FDDBYT),A	; RESTORE IT TO THE MEMORY IMAGE
  946	  F67D    D3 18          C      	OUT	(FDD),A		; AND LATCH
  947	  F67F    3A F878        C      	LD	A,(MOTFLG)	; MOTOR ON-OFF FLAG
  948	  F682    FE 00          C      	CP	0		; MOTOR OFF?
  949	  F684    C0             C      	RET	NZ		; NO, SKIP DELAY
  950	  F685    3E 01          C      	LD	A,1
  951	  F687    32 F878        C      	LD	(MOTFLG),A	; SET MOTOR ON FLAG
  952	  F68A    01 9C40        C      	LD	BC,40000	; NEEDS DELAY FOR ABOUT 300MSEC
  953	  F68D    0B             C      SELS20:	DEC	BC		; COUNT DOWN
  954	  F68E    78             C      	LD	A,B
  955	  F68F    B1             C      	OR	C		; REACHED ZERO YET?
  956	  F690    20 FB          C      	JR	NZ,SELS20	; NO, LOOP BACK
  957	  F692    C9             C      	RET			; ALL DONE.
  958	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-24
802FSUBS.MAC--SUBROUTINES MODULE

  959	                         C      ; SELECT THE DRIVE IN HARDWARE.
  960	                         C      ; DRIVE TO BE SELECTED IS PASSED
  961	                         C      ; IN REGISTER A.
  962	                         C      
  963	  F693    77             C      SELDRV:	LD	(HL),A		; SAVE CURRENT DRIVE FOR LATER
  964	  F694    0E 10          C      	LD	C,00010000B	; THIS IS THE MASK FOR DRIVE 0
  965	                         C      
  966	  F696    B7             C      SELD10:	OR	A		; HAVE WE GOT THE RIGHT MASK?
  967	  F697    28 05          C      	JR	Z,SELD20	; YES.
  968	  F699    CB 21          C      	SLA	C		; SHIFT DRIVE MASK OVER 1 BIT LEFT.
  969	  F69B    3D             C      	DEC	A		; DOWN THE COUNTER.
  970	  F69C    18 F8          C      	JR	SELD10		; AND LOOP.
  971	                         C      
  972	  F69E    3A F976        C      SELD20:	LD	A,(FDDBYT)	; GET MEMORY IMAGE OF DRIVE LATCH
  973	  F6A1    E6 0F          C      	AND	00001111B	; AND OFF CURRENT DRIVE SELECT BITS.
  974	  F6A3    B1             C      	OR	C		; OUT WITH THE OLD, IN WITH THE NEW
  975	  F6A4    32 F976        C      	LD	(FDDBYT),A	; RESTORE MEMORY IMAGE.
  976	  F6A7    D3 18          C      	OUT	(FDD),A		; AND INFORM LATCH ABOUT NEW DRIVE.
  977	  F6A9    C9             C      	RET
  978	                         C      
  979	                         C      ; RESET THE DISK SUBSYSTEM BY RESTORING
  980	                         C      ; ALL THE HEADS TO TRACK 0.  RESTORING
  981	                         C      ; DRIVES IN REVERSE ORDER ASSURES THAT
  982	                         C      ; DRIVE A WILL ALWAYS BE SELECTED UPON
  983	                         C      ; COMPLETION.
  984	                         C      
  985	  F6AA    3E 02          C      RESDSK:	LD	A,00000010B	; INITIALIZE THE FDD LATCH, MOTOR ON
  986	  F6AC    32 F976        C      	LD	(FDDBYT),A	; MEMORY IMAGE.
  987	  F6AF    D3 18          C      	OUT	(FDD),A		; HARDWARE LATCH.
  988	  F6B1    06 01          C      	LD	B,MAXDRV	; INITIAL DRIVE NO.
  989	                         C      
  990	  F6B3    78             C      RESD10:	LD	A,B		; SELECT THE DRIVE
  991	  F6B4    32 F97F        C      	LD	(HSTDSK),A	; STORE IT IN HSTDSK
  992	  F6B7    21 F876        C      	LD	HL,DRIVE
  993	  F6BA    CD F693        C      	CALL	SELDRV
  994	  F6BD    CD F6C5        C      	CALL	RESTOR		; RESTORE THE HEADS TO TRACK 0
  995	  F6C0    05             C      	DEC	B		; DECREMENT DRIVE NO.
  996	  F6C1    F2 F6B3        C      	JP	P,RESD10	; LOOP FOR NEXT DRIVE
  997	  F6C4    C9             C      	RET
  998	                         C      
  999	                         C      ; RESTORE THE HEADS ON THE CURRENTLY
 1000	                         C      ; SELECTED DRIVE TO TRACK 0.  THIS IS
 1001	                         C      ; DONE AFTER EACH SEEK, READ, OR, WRITE
 1002	                         C      ; FAILURE. ALSO AT WARM AND COLD BOOT.
 1003	                         C      ; WE MUST RESET THE CURRENT TRACK FOR
 1004	                         C      ; THIS DRIVE ALSO.
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-25
802FSUBS.MAC--SUBROUTINES MODULE

 1005	                         C      
 1006	  F6C5    3A F97F        C      RESTOR:	LD	A,(HSTDSK)	; GET THE CURRENT DRIVE
 1007	  F6C8    21 F98F        C      	LD	HL,TRKTAB	; BASE ADDRESS OF CURRENT TRACK TABLE
 1008	  F6CB    5F             C      	LD	E,A
 1009	  F6CC    16 00          C      	LD	D,0		; MAKE DRIVE NO. AN INDEX.
 1010	  F6CE    19             C      	ADD	HL,DE		; ADD IN INDEX.
 1011	  F6CF    36 00          C      	LD	(HL),0		; CLEAR CURRENT TRACK TO 0.
 1012	  F6D1    3E 00          C      	LD	A,RESCMD	; FDC RESTORE COMMAND
 1013	  F6D3    D3 14          C      	OUT	(FDCCMD),A	; SEND IT.
 1014	  F6D5    CD F5DB        C      	CALL	WAIT		; WAIT FOR COMPLETION
 1015	  F6D8    C9             C      	RET
 1016	                         C      
 1017	                         C      ; RESET THE DMA SIX TIMES TOTAL
 1018	                         C      
 1019	  F6D9    C5             C      RESDMA:	PUSH	BC		; DON'T DESTROY REGGIES
 1020	  F6DA    06 06          C      	LD	B,6		; COUNTER
 1021	  F6DC    3E C3          C      RDMA10:	LD	A,11000011B	; RESET THE DMA
 1022	  F6DE    D3 10          C      	OUT	(DMA),A		; SO THAT IT DOESN'T RUN ON.
 1023	  F6E0    10 FA          C      	DJNZ	RDMA10		; LOOP FOR ANOTHER TIME
 1024	  F6E2    C1             C      	POP	BC		; RESTORE REGISTER PAIR
 1025	  F6E3    C9             C      	RET			; ALL DONE
 1026	                         C      
 1027	                         C      ; MISCELANEOUS ROUTINES
 1028	                         C      
 1029	                         C      ; PRINT THE STRING POINTED TO BY HL
 1030	                         C      ; AND TERMINATED BY NULL (0).
 1031	                         C      
 1032	  F6E4    7E             C      PRTMSG:	LD	A,(HL)
 1033	  F6E5    B7             C      	OR	A
 1034	  F6E6    C8             C      	RET	Z		; ALL DONE
 1035	                         C      
 1036	  F6E7    4F             C      	LD	C,A
 1037	  F6E8    CD F366        C      	CALL	CRTOUT		; OUTPUT IT
 1038	  F6EB    23             C      	INC	HL
 1039	  F6EC    18 F6          C      	JR	PRTMSG		; AND LOOP BACK
 1040	                         C      
 1041	                         C      ; GENERAL PORT INITIALIZATION ROUTINE
 1042	                         C      ;	ENTRY:		HL	->	PORT ADDRESS
 1043	                         C      ;					BYTE COUNT
 1044	                         C      ;					DATA
 1045	                         C      ;					 |
 1046	                         C      ;					 |
 1047	                         C      
 1048	  F6EE    4E             C      PRTINI:	LD	C,(HL)		; GET PORT ADDRESS
 1049	  F6EF    23             C      	INC	HL		
 1050	  F6F0    46             C      PRTENT:	LD	B,(HL)		; GET THE COUNT
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-26
802FSUBS.MAC--SUBROUTINES MODULE

 1051	  F6F1    23             C      	INC	HL		; POINT TO FIRST DATA BYTE
 1052	  F6F2    ED B3          C      	OTIR			; BLOCK OUTPUT
 1053	  F6F4    C9             C      	RET
 1054	                         C      
 1055	                         C      ; ADDITIONAL HARWARE SYSTEM 
 1056	                         C      ; HARDWARE INITIALIZATION 
 1057	                         C      ; COMES NEXT.
 1058	                         C      
 1059	  F6F5    CD F6AA        C      HDWINI:	CALL	RESDSK		; RESET THE DISK SUBSYSTEM
 1060	  F6F8    21 F7A1        C      	LD	HL,SIOTAB	; INITIALIZE SIO #1 FOR SERIAL PRINTER
 1061	  F6FB    CD F6EE        C      	CALL	PRTINI		; BAUD RATE IS SET UP IN PROM CODE
 1062	                         C      				; BY READING THE DIP SWITCH
 1063	  F6FE    C9             C      	RET			; MAY BE MORE LATER
 1064	                         C      
 1065	                         C      ; THIS ROUTINE TRANSFERS CONTROL TO 
 1066	                         C      ; THE I/O DRIVER INDICATED BY THE 
 1067	                         C      ; APPROPRIATE BITS IN IOBYTE (0003H).
 1068	                         C      ; ENTRY:	HL ->	<DEVICE TYPE>
 1069	                         C      ;			<DEVICE 1 ADDRESS>
 1070	                         C      ;			<DEVICE 2 ADDRESS>
 1071	                         C      ;			<DEVICE 3 ADDRESS>
 1072	                         C      ;			<DEVICE 4 ADDRESS>
 1073	                         C      
 1074	  F6FF    E1             C      IODISP:	POP	HL		; GET DISPATCH TABLE POINTER
 1075	  F700    C5             C      	PUSH	BC		; SAVE PERTINENT REGISTERS
 1076	  F701    D5             C      	PUSH	DE
 1077	  F702    7E             C      	LD	A,(HL)		; DEVICE TYPE
 1078	  F703    23             C      	INC	HL		; ADVANCE POINTER
 1079	  F704    47             C      	LD	B,A		; SAVE DEVICE TYPE FOR LATER
 1080	  F705    B7             C      	OR	A		; WHICH DEVICE?
 1081	  F706    3A 0003        C      	LD	A,(IOBYTE)	; RETREIVE CURRENT IOBYTE
 1082	  F709    28 03          C      	JR	Z,IODI20	; NO SHIFTING NEEDED
 1083	                         C      
 1084	  F70B    1F             C      IODI10:	RRA			; ROTATE BYTE UNTIL DEVICE BITS
 1085	  F70C    10 FD          C      	DJNZ	IODI10		; ARE LINED UP WITH BIT 0
 1086	                         C      
 1087	  F70E    E6 03          C      IODI20:	AND	03H		; MASK OFF DON'T CARE BITS
 1088	  F710    17             C      	RLA			; FORM WORD OFFSET
 1089	  F711    4F             C      	LD	C,A		; FORM 16 BITS, B ALREADY 0
 1090	  F712    09             C      	ADD	HL,BC		; ADD IN BASE ADDRESS
 1091	  F713    5E             C      	LD	E,(HL)		; TRANSFER DISPATCH ADDRESS
 1092	  F714    23             C      	INC	HL		; TO REGISTERS DE
 1093	  F715    56             C      	LD	D,(HL)
 1094	  F716    EB             C      	EX	DE,HL		; RESULT INTO HL
 1095	  F717    D1             C      	POP	DE		; RESTORE REGISTERS
 1096	  F718    C1             C      	POP	BC
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-27
802FSUBS.MAC--SUBROUTINES MODULE

 1097	  F719    E9             C      	JP	(HL)		; OFF WE GO, INTO THE WILD BLUE YONDER!
 1098	                         C      
 1099	                         C      ; THIS ROUTINE FILLS OUT THE DETAILED ERROR MESSAGE TABLE
 1100	                         C      ; OBTAINING VARIABLE VALUES FROM CURRENT STATE.
 1101	                         C      ; THEN CALLS PRTMSG ROUTINE WITH THE TABLE ADDRESS IN HL
 1102	                         C      
 1103	  F71A    3A F975        C      ERRPRT:	LD	A,(COMAND)	; CURRENT COMMAND
 1104	  F71D    FE 80          C      	CP	80H		; READ?
 1105	  F71F    20 05          C      	JR	NZ,WRMSG	; NO, SKIP
 1106	  F721    21 F830        C      	LD	HL,RMSG		; READ MESSAGE
 1107	  F724    18 03          C      	JR	ERR10
 1108	  F726    21 F835        C      WRMSG:	LD	HL,WMSG		; WRITE MESSAGE
 1109	  F729    11 F7F5        C      ERR10:	LD	DE,VCMD		; COMMAND MESSAGE ADDRESS IN TABLE
 1110	  F72C    01 0005        C      	LD	BC,5
 1111	  F72F    ED B0          C      	LDIR			; STORE IN TABLE
 1112	  F731    21 F808        C      	LD	HL,VSIDE	; SIDE VARIABLE
 1113	  F734    3A F976        C      	LD	A,(FDDBYT)	; MEMORY IMAGE
 1114	  F737    CB 57          C      	BIT	2,A		; SIDE BIT
 1115	  F739    28 04          C      	JR	Z,ONE		; 0 - SIDE 1
 1116	  F73B    36 32          C      	LD	(HL),32H	; ASCII	2
 1117	  F73D    18 02          C      	JR	CONT10
 1118	  F73F    36 31          C      ONE:	LD	(HL),31H	; ASCII 1
 1119	  F741    21 F812        C      CONT10:	LD	HL,VTRK		; TRACK VARIABLE
 1120	  F744    3A F980        C      	LD	A,(HSTTRK)	; CURRENT TRACK NUMBER
 1121	  F747    CD F763        C      	CALL	FTAB		; FILL OUT TABLE ROUTINE
 1122	  F74A    21 F81E        C      	LD	HL,VSEC		; SECTOR VARIABLE
 1123	  F74D    3A F877        C      	LD	A,(TSEC)	; CURRENT TARGET SECTOR
 1124	  F750    CD F763        C      	CALL	FTAB
 1125	  F753    21 F82D        C      	LD	HL,VSTAT	; ERROR STATUS
 1126	  F756    3A F989        C      	LD	A,(ERFLAG)	; GET ERROR FLAG
 1127	  F759    CD F763        C      	CALL	FTAB
 1128	  F75C    21 F7F3        C      	LD	HL,ERRMSG	; ERROR MESSAGE TABLE ADDRESS
 1129	  F75F    CD F6E4        C      	CALL	PRTMSG
 1130	  F762    C9             C      	RET
 1131	                         C      
 1132	                         C      ; THIS ROUTINE CONVERTS HEX CODE INTO ASCII AND FILL OUT THE TABLE
 1133	                         C      
 1134	  F763    F5             C      FTAB:	PUSH	AF		; SAVE REGISTERS
 1135	  F764    0F             C      	RRCA			; ROTATE RIGHT 4 TIMES
 1136	  F765    0F             C      	RRCA
 1137	  F766    0F             C      	RRCA
 1138	  F767    0F             C      	RRCA
 1139	  F768    CD F773        C      	CALL	GHEX		; CONVERT HIGH ORDER 4 BITS TO ASCII
 1140	  F76B    77             C      	LD	(HL),A		; STORE INTO TABLE
 1141	  F76C    23             C      	INC	HL		; NEXT TABLE LOCATION
 1142	  F76D    F1             C      	POP	AF		; RESTORE REGISTERS
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-28
802FSUBS.MAC--SUBROUTINES MODULE

 1143	  F76E    CD F773        C      	CALL	GHEX		
 1144	  F771    77             C      	LD	(HL),A		
 1145	  F772    C9             C      	RET
 1146	                         C      
 1147	                         C      ; HEX INTO ASCII ROUTINE
 1148	                         C      
 1149	  F773    E6 0F          C      GHEX:	AND	0FH		; STRIP HIGH 4 BITS
 1150	  F775    FE 0A          C      	CP	10		; NUMERIC?
 1151	  F777    30 03          C      	JR	NC,G10		; YES, SKIP FOR ALPHA
 1152	  F779    C6 30          C      	ADD	A,'0'		; ADD 30
 1153	  F77B    C9             C      	RET
 1154	  F77C    C6 37          C      G10:	ADD	A,'A'-10	; ADD 40
 1155	  F77E    C9             C      	RET
 1156	                         C      
 1157	                         C      ; END OF 802FSUBS.MAC
 1158	                         C      
 1159	                                
 1160	                                	SUBTTL 802FEQU.MAC--EQUATES MODULE
 1161	                                	PAGE
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-29
802FEQU.MAC--EQUATES MODULE

 1162	                                
 1163	                         C      	INCLUDE 802FEQU.MAC
 1164	                         C      
 1165	                         C      ;	BDOS CONSTANTS ON ENTRY TO WRITE
 1166	                         C      
 1167	  0000                   C      WRALL	EQU	0		;WRITE TO ALLOCATED
 1168	  0001                   C      WRDIR	EQU	1		;WRITE TO DIRECTORY
 1169	  0002                   C      WRUAL	EQU	2		;WRITE TO UNALLOCATED
 1170	                         C      
 1171	                         C      ; SIO #0 PORT DEFINITIONS
 1172	                         C      ; CHANNEL B FOR CRT
 1173	                         C      
 1174	  000C                   C      SIOAD0	EQU	0CH		; CHANNEL A DATA PORT FOR SIO 0
 1175	  000E                   C      SIOAC0	EQU	0EH		; CHANNEL A CONTROL PORT
 1176	  000D                   C      SIOBD0	EQU	0DH		; CHANNEL B DATA PORT FOR SIO 0
 1177	  000F                   C      SIOBC0	EQU	0FH		; CHANNEL B CONTROL PORT
 1178	                         C      
 1179	                         C      ; SIO #1 PORT DEFINITIONS
 1180	                         C      ; CHANNEL B FOR PRINTER
 1181	                         C      
 1182	  0020                   C      SIOAD1	EQU	20H		; CHANNEL A DATA PORT FOR SIO 1
 1183	  0022                   C      SIOAC1	EQU	22H		; CHANNEL A CONTROL PORT
 1184	  0021                   C      SIOBD1	EQU	21H		; CHANNEL B DATA PORT FOR SIO 1
 1185	  0023                   C      SIOBC1	EQU	23H		; CHANNEL B CONTROL PORT
 1186	                         C      
 1187	                         C      ; CTC PORT DEFINITIONS
 1188	                         C      
 1189	  0008                   C      CTC0	EQU	08H		; TERMINAL BAUD RATE GENERATOR
 1190	  0009                   C      CTC1	EQU	09H		; SERIAL PRINTER BAUD RATE GENERATOR
 1191	  000A                   C      CTC2	EQU	0AH		; REAL TIME CLOCK CHANNEL
 1192	  000B                   C      CTC3	EQU	0BH		; FLOPPY DISK INTERRUPT CHANNEL
 1193	                         C      
 1194	                         C      ; PIO PORT DEFINITIONS
 1195	                         C      
 1196	  001C                   C      PIOAD	EQU	1CH		; PIO CHANNEL A DATA PORT
 1197	  001E                   C      PIOAC	EQU	1EH		; PIO CHANNEL A CONTROL PORT
 1198	  001D                   C      PIOBD	EQU	1DH		; PIO CHANNEL B DATA PORT
 1199	  001F                   C      PIOBC	EQU	1FH		; PIO CHANNEL B CONTROL PORT
 1200	                         C      
 1201	                         C      ; SIO STATUS BIT DEFINITIONS
 1202	                         C      
 1203	  0000                   C      RCVRDY	EQU	0		; RECEIVE CHARACTER AVAILABLE
 1204	  0002                   C      TRXRDY	EQU	2		; TRANSMITTER BUFFER EMPTY
 1205	                         C      
 1206	                         C      ; PIO CENTRONICS PRINTER INTERFACE DEFINITIONS
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-30
802FEQU.MAC--EQUATES MODULE

 1207	                         C      
 1208	  0000                   C      STROBE	EQU	0		; PRINTER STROBE LINE
 1209	  0038                   C      PIOMSK	EQU	00111000B	; MASK FOR READY, PAPER OUT, FAULT
 1210	  0008                   C      PIOERR	EQU	00001000B	; ERROR STATE MASK
 1211	  0005                   C      PRTBSY	EQU	05H		; PRINTER BUSY IS BIT #5 IN STATUS BYTE
 1212	                         C      
 1213	                         C      ; FDC EQUATES
 1214	                         C      
 1215	  0014                   C      FDCCMD	EQU	14H		; FDC STATUS AND COMMAND PORT
 1216	  0015                   C      FDCTRK	EQU	15H		; FDC TRACK PORT
 1217	  0016                   C      FDCSEC	EQU	16H		; FDC SECTOR PORT
 1218	  0017                   C      FDCDAT	EQU	17H		; FDC DATA PORT
 1219	                         C      
 1220	                         C      ; FLOPPY DRIVE SELECT LATCH
 1221	                         C      
 1222	  0018                   C      FDD	EQU	18H		; DRIVE SELECT LATCH
 1223	                         C      
 1224	                         C      ; SYSTEM PROM SWITCH ADDRESS
 1225	                         C      
 1226	  0004                   C      PROMSW	EQU	04H		; SYSTEM PROM DISABLE ADDRESS
 1227	  0004                   C      DEFDSK	EQU	04H		; DEFAULT DRIVE NUMBER
 1228	                         C      
 1229	                         C      ; DMA PORT ADDRESS
 1230	                         C      
 1231	  0010                   C      DMA	EQU	10H		; DMA PORT ADDRESS
 1232	                         C      
 1233	                         C      ; FDC STATUS BITS
 1234	                         C      
 1235	  0000                   C      FDCBSY	EQU	0		; FDC BUSY IS BIT 0
 1236	  0001                   C      FDCIND	EQU	1		; FDC INDEX HOLE DETECTED
 1237	  0002                   C      FDCTR0	EQU	2		; FDC TRACK 0 DETECTED
 1238	  0003                   C      FDCCRC	EQU	3		; FDC CRC ERROR ENCOUNTERED
 1239	  0004                   C      FDCSEE	EQU	4		; FDC SEEK ERROR ENCOUNTERED
 1240	  0005                   C      FDCHLD	EQU	5		; FDC HEAD LOAD ACK.
 1241	  0006                   C      FDCPRT	EQU	6		; FDC DISK IS WRITE PROTECTED
 1242	  0007                   C      FDCRDY	EQU	7		; FDC DISK NOT READY BIT
 1243	                         C      
 1244	                         C      ; FDC STATUS BYTE MASKS
 1245	                         C      
 1246	  00DC                   C      ERRMSK	EQU	11011100B	; MASK OFF INSIGNIFICANT BITS
 1247	  0098                   C      SEEMSK	EQU	10011000B	; CHECK THE NOT READY BIT
 1248	  0080                   C      DNRMSK	EQU	10000000B	; DRIVE NOT READY MASK
 1249	                         C      
 1250	                         C      ; FDC COMMAND BYTES
 1251	                         C      
 1252	  0000                   C      RESCMD	EQU	00000000B	; HOME HEAD COMMAND, NO VERIFY
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-31
802FEQU.MAC--EQUATES MODULE

 1253	  0014                   C      SEECMD	EQU	00010100B	; SEEK TRACK COMMAND
 1254	  0034                   C      HDSCMD	EQU	00110100B	; HEAD STEP, PREVIOUS DIRECTION
 1255	  0054                   C      HSICMD	EQU	01010100B	; HEAD STEP IN, TOWARD HUB.
 1256	  0074                   C      HSOCMD	EQU	01110100B	; HEAD STEP OUT, TOWARD EDGE.
 1257	  0080                   C      RDSCMD	EQU	10000000B	; READ SECTOR
 1258	  00A0                   C      WTSCMD	EQU	10100000B	; WRITE SECTOR
 1259	  00C0                   C      RDACMD	EQU	11000000B	; READ SECTOR ADDRESS
 1260	  00E0                   C      RDTCMD	EQU	11100000B	; READ TRACK
 1261	  00F0                   C      WTTCMD	EQU	11110000B	; WRITE TRACK
 1262	  00D0                   C      FRCCMD	EQU	11010000B	; FORCE TERMINATION
 1263	                         C      
 1264	                         C      ; ASCII EQUATES
 1265	                         C      
 1266	  0003                   C      ASCETX	EQU	03H		; ASCII END OF TRANSMISSION
 1267	  0006                   C      ASCACK	EQU	06H		; ASCII ACKNOWLEDGEMENT
 1268	  000A                   C      ASCLF	EQU	0AH		; ASCII LINE FEED
 1269	  000D                   C      ASCCR	EQU	0DH		; ASCII CARRIAGE RETURN
 1270	                         C      
 1271	                         C      ; CP/M EQUATES
 1272	                         C      
 1273	  0080                   C      CPMBUF	EQU	80H		; DEFAULT CP/M DMA ADDRESS
 1274	  0003                   C      IOBYTE	EQU	0003H
 1275	  0004                   C      LOGDRV	EQU	0004H		; CURRENTLY LOGGED DRIVE ADDRESS
 1276	  00C3                   C      JP	EQU	0C3H		; JUMP OPCODE.
 1277	  0080                   C      RECLEN	EQU	128		; NO. OF BYTES IN CP/M RECORD (SECTOR).
 1278	  1600                   C      BDOSLN	EQU	1600H		; LENGTH OF BDOS, IN BYTES.
 1279	  0800                   C      CCPLEN	EQU	800H		; LENGTH OF CCP, IN BYTES
 1280	                         C      
 1281	                         C      ; DISK PARAMETER BLOCKS.
 1282	                         C      ; FIRST COME THE EQUATES 
 1283	                         C      ; FOR DISK PARAMETER BLOCKS
 1284	                         C      
 1285	  0020                   C      BPDE	EQU	32		; BYTES/DIRECTORY ENTRY
 1286	                         C      
 1287	                         C      ; DRIVE 0 EQUATES
 1288	                         C      
 1289	  0002                   C      OFF0	EQU	2		; NUMBER OF TRACK RESERVED FOR CP/M O.S.
 1290	  0028                   C      TPD0	EQU	40		; NUMBER OF TRACKS/DISK
 1291	  0100                   C      BPS0	EQU	256		; NUMBER OF BYTES/SECTOR
 1292	  0002                   C      NSIDE0	EQU	2		; NUMBER OF SIDE/DISK
 1293	  0012                   C      PSPT0	EQU	18		; NUMBER OF PHYSICAL SECTOR/TRACK
 1294	  0048                   C      SPT0	EQU	((BPS0/128)*PSPT0)*NSIDE0	;NUMBER OF CP/M SECTOR/TRACK
 1295	  0B40                   C      SPD0	EQU	SPT0*TPD0	; NUMBER OF SECTORS/DISK
 1296	  0040                   C      EPD0	EQU	64		; NUMBER OF DIRECTORY ENTRIES 
 1297	  0800                   C      BLS0	EQU	2048		; BLOCK SIZE
 1298	  0004                   C      BSH0	EQU	4		; BLOCK SHIFT FACTOR
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-32
802FEQU.MAC--EQUATES MODULE

 1299	  000F                   C      BLM0	EQU	(BLS0/128)-1	; BLOCK MASK
 1300	  0000                   C      EXM0	EQU	0		; EXTENT MASK
 1301	  00AA                   C      DSM0	EQU	((SPD0-(SPT0*OFF0))/(BLM0+1))-1	;CP/M BLOCK PER DISK
 1302	  003F                   C      DRM0	EQU	EPD0-1 		; DIRECTORY ENTRIES - 1
 1303	  0080                   C      ALL0	EQU	10000000B	; DIRECTORY BLOCK BIT MAP LOW
 1304	  0000                   C      ALH0	EQU	0B		; DIRECTORY BLOCK BIT MAP HIGH
 1305	  0010                   C      CKS0	EQU	(DRM0+1)/4	; SIZE OF DIRECTORY CHECK VECTOR
 1306	                         C      
 1307	                         C      ; DRIVE 1 EQUATES
 1308	                         C      
 1309	  0002                   C      OFF1	EQU	2		; NUMBER OF TRACK RESERVED FOR CP/M O.S.
 1310	  0028                   C      TPD1	EQU	40		; NUMBER OF TRACKS/DISK
 1311	  0100                   C      BPS1	EQU	256		; NUMBER OF BYTES/SECTOR
 1312	  0002                   C      NSIDE1	EQU	2		; NUMBER OF DISK SIDE
 1313	  0012                   C      PSPT1	EQU	18		; NUMBER OF PHYSICAL SECTOR/TRACK
 1314	  0048                   C      SPT1	EQU	((BPS1/128)*PSPT1)*NSIDE1 ; NUMBER OF CP/M SECTORS/TRACK
 1315	  0B40                   C      SPD1	EQU	SPT1*TPD1	; NUMBER OF SECTORS/DISK
 1316	  0040                   C      EPD1	EQU	64		; NUMBER OF DIRECTORY ENTRIES
 1317	  0800                   C      BLS1	EQU	2048		; BLOCK SIZE
 1318	  0004                   C      BSH1	EQU	4		; BLOCK SHIFT FACTOR
 1319	  000F                   C      BLM1	EQU	(BLS1/128)-1	; BLOCK MASK
 1320	  0000                   C      EXM1	EQU	0		; EXTENT MASK
 1321	  00AA                   C      DSM1	EQU	((SPD1-(SPT1*OFF1))/(BLM0+1))-1	; CP/M BLOCK PER DISK
 1322	  003F                   C      DRM1	EQU	EPD1-1		; DIRECTORY ENTRIES-1
 1323	  0080                   C      ALL1	EQU	10000000B	; DIRECTORY BLOCK BIT MAP LOW
 1324	  0000                   C      ALH1	EQU	0B		; DIRECTORY BLOCK BIT MAP HIGH
 1325	  0010                   C      CKS1	EQU	(DRM1+1)/4	; SIZE OF DIRECTORY CHECK VECTOR
 1326	                         C      
 1327	                         C      ; CP/M HOST DISK CONSTANTS
 1328	                         C      
 1329	  0800                   C      BLKSIZ	EQU	BLS0		; CP/M ALLOCATION BLOCK SIZE
 1330	  0100                   C      HSTSIZ	EQU	BPS0		; SYSTEM DISK SECTOR SIZE
 1331	  0024                   C      HSTSPT	EQU	PSPT0*NSIDE0	; SYSTEM DISK SECTOR PER TRACK
 1332	  0002                   C      HSTBLK	EQU	HSTSIZ/128	; CP/M SECTORS/HOST BUFFER
 1333	  0048                   C      CPMSPT	EQU	HSTBLK*HSTSPT	; CP/M SECTOR PER TRACK
 1334	  0001                   C      SECMSK	EQU	HSTBLK-1	; SECTOR MASK
 1335	  0001                   C      MAXDRV	EQU	1		; MAXIMUM DRIVE NO.
 1336	  0002                   C      NODRVS	EQU	MAXDRV+1	; NO. OF DRIVES IN SYSTEM
 1337	  000A                   C      NOTRYS	EQU	10		; NO. OF RETRIES ON SEEK, READ, WRITE.
 1338	                         C      
 1339	                         C      ; END OF 802FEQU.MAC
 1340	                                
 1341	                                	SUBTTL	802FDATA.MAC--DATA DEFINITION MODULE
 1342	                                	PAGE
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-33
802FDATA.MAC--DATA DEFINITION MODULE

 1343	                                
 1344	                         C      	INCLUDE 802FDATA.MAC
 1345	                         C      
 1346	                         C      ; DATA STORAGE
 1347	                         C      
 1348	                         C      ; DMA INITIALIZATION TABLES FOR READ 
 1349	                         C      ; AND WRITE OPERATIONS
 1350	                         C      
 1351	  F77F    10             C      RDSTAB:	DEFB	DMA		; PORT ADDRESS
 1352	  F780    0F             C      	DEFB	15		; TABLE COUNT
 1353	  F781    C3             C      	DEFB	11000011B	; RESET THE DMA
 1354	  F782    6D             C      	DEFB	01101101B	; PORT ADDRESS FOLLOWS 
 1355	  F783    17             C      	DEFB	FDCDAT		; FDC DATA PORT ADDRESS
 1356	  F784    00FF           C      	DEFW	0FFH		; DISK BUFFER - 1
 1357	  F786    3C             C      	DEFB	00111100B	; PORT A IS FIXED
 1358	  F787    10             C      	DEFB	00010000B	; PORT B IS MEMORY, INCREMENTS
 1359	  F788    CD             C      	DEFB	11001101B	; PORT B MEMORY ADDRESS FOLLOWS
 1360	  F789    F991           C      	DEFW	HSTBUF		; ADDRESS OF DISK BUFFER
 1361	  F78B    8A             C      	DEFB	10001010B	; READY ACTIVE HIGH, END OF BLOCK
 1362	  F78C    CF             C      	DEFB	11001111B	; LOAD REGISTERS
 1363	  F78D    05             C      	DEFB	00000101B	; A -> B, TRANSFER MODE
 1364	  F78E    CF             C      	DEFB	11001111B	; LOAD REGISTERS
 1365	  F78F    87             C      	DEFB	10000111B	; ARM THE DMA
 1366	                         C       
 1367	  F790    10             C      WTSTAB:	DEFB	DMA		; PORT ADDRESS
 1368	  F791    0F             C      	DEFB	15		; TABLE COUNT
 1369	  F792    C3             C      	DEFB	11000011B	; RESET THE DMA
 1370	  F793    6D             C      	DEFB	01101101B	; PORT ADDRESS FOLLOWS 
 1371	  F794    17             C      	DEFB	FDCDAT		; FDC DATA PORT ADDRESS
 1372	  F795    00FF           C      	DEFW	0FFH		; DISK BUFFER - 1
 1373	  F797    3C             C      	DEFB	00111100B	; PORT A IS FIXED
 1374	  F798    10             C      	DEFB	00010000B	; PORT B IS MEMORY, INCREMENTS
 1375	  F799    CD             C      	DEFB	11001101B	; PORT B MEMORY ADDRESS FOLLOWS
 1376	  F79A    F991           C      	DEFW	HSTBUF		; ADDRESS OF DISK BUFFER
 1377	  F79C    8A             C      	DEFB	10001010B	; READY ACTIVE HIGH, END OF BLOCK
 1378	  F79D    CF             C      	DEFB	11001111B	; LOAD REGISTERS
 1379	  F79E    01             C      	DEFB	00000001B	; B -> A, TRANSFER MODE
 1380	  F79F    CF             C      	DEFB	11001111B	; LOAD REGISTERS
 1381	  F7A0    87             C      	DEFB	10000111B	; ARM THE DMA
 1382	                         C      
 1383	                         C      ; SIO INITIALIZATION TABLE FOR
 1384	                         C      ; SERIAL PRINTER, 9600 BAUD,
 1385	                         C      ; ETX/ACK PROTOCOL.
 1386	                         C      
 1387	  F7A1    23             C      SIOTAB:	DEFB	SIOBC1		; PORT ADDRESS
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-34
802FDATA.MAC--DATA DEFINITION MODULE

 1388	  F7A2    08             C      	DEFB	8		; TABLE SIZE
 1389	  F7A3    18             C      	DEFB	00011000B	; CHANNEL RESET
 1390	  F7A4    18             C      	DEFB	00011000B	; ANOTHER ONE
 1391	  F7A5    14             C      	DEFB	00010100B	; EXTERNAL STATUS RESET, POINT TO WR4
 1392	  F7A6    4C             C      	DEFB	01001100B	; X16 CLOCK, 2 STOP BITS
 1393	  F7A7    03             C      	DEFB	00000011B	; POINT TO WR3
 1394	  F7A8    C1             C      	DEFB	11000001B	; 8 BITS RX, RX ENABLE
 1395	  F7A9    05             C      	DEFB	00000101B	; POINT TO WR5
 1396	  F7AA    EA             C      	DEFB	11101010B	; DTR, 8 BITS TX, RTS, TX ENABLE
 1397	                         C      
 1398	                         C      ; CTC IS BAUD GENERATOR FOR
 1399	                         C      ; SIO.
 1400	                         C      
 1401	  F7AB    09             C      CTCTAB:	DEFB	CTC1		; PORT ADDRESS FOR CTC
 1402	  F7AC    02             C      	DEFB	2		; TABLE SIZE
 1403	  F7AD    47             C      	DEFB	01000111B	; COUNTER MODE, VALUE FOLLOWS
 1404	  F7AE    04             C      	DEFB	4		; COUNTDOWN FOR 9600 BAUD
 1405	                         C      
 1406	                         C      ; MESSAGES, MESSAGES
 1407	                         C      
 1408	  F7AF    0D             C      SIGNON:	DEFB	0DH
 1409	  F7B0    0A             C      	DEFB	0AH
 1410	  F7B1    54 45 4C 45    C      	DEFB	'TELEVIDEO SYSTEM TS-802 V2.0'
 1411	  F7B5    56 49 44 45    C      
 1412	  F7B9    4F 20 53 59    C      
 1413	  F7BD    53 54 45 4D    C      
 1414	  F7C1    20 54 53 2D    C      
 1415	  F7C5    38 30 32 20    C      
 1416	  F7C9    56 32 2E 30    C      
 1417	  F7CD    0D             C      	DEFB	0DH
 1418	  F7CE    0A             C      	DEFB	0AH
 1419	  F7CF    36 32 6B 20    C      	DEFM	'62k CP/M vers 2.2'
 1420	  F7D3    43 50 2F 4D    C      
 1421	  F7D7    20 76 65 72    C      
 1422	  F7DB    73 20 32 2E    C      
 1423	  F7DF    32             C      
 1424	  F7E0    0D             C      	DEFB	0DH
 1425	  F7E1    0A             C      	DEFB	0AH
 1426	  F7E2    00             C      	DEFB	0		; TERMINATION
 1427	                         C      
 1428	  F7E3    0D             C      BOOMSG:	DEFB	0DH
 1429	  F7E4    0A             C      	DEFB	0AH
 1430	  F7E5    42 6F 6F 74    C      	DEFM	'Boot Error.'	; ERROR ON WARM BOOT
 1431	  F7E9    20 45 72 72    C      
 1432	  F7ED    6F 72 2E       C      
 1433	  F7F0    0D             C      	DEFB	0DH
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-35
802FDATA.MAC--DATA DEFINITION MODULE

 1434	  F7F1    0A             C      	DEFB	0AH
 1435	  F7F2    00             C      	DEFB	0
 1436	                         C      
 1437	                         C      ; DETAILED ERROR MESSAGE TABLE
 1438	                         C      
 1439	  F7F3    0D             C      ERRMSG:	DEFB	0DH
 1440	  F7F4    0A             C      	DEFB	0AH
 1441	  F7F5                   C      VCMD:	DEFS	5		; COMMAND
 1442	  F7FA    20 45 52 52    C      	DEFB	' ERROR: SIDE# '
 1443	  F7FE    4F 52 3A 20    C      
 1444	  F802    53 49 44 45    C      
 1445	  F806    23 20          C      
 1446	  F808                   C      VSIDE:	DEFS	1		; SIDE
 1447	  F809    2C 20 54 52    C      	DEFB	', TRACK# '
 1448	  F80D    41 43 4B 23    C      
 1449	  F811    20             C      
 1450	  F812                   C      VTRK:	DEFS	2		; TRACK NUMBER
 1451	  F814    2C 20 53 45    C      	DEFB	', SECTOR# '
 1452	  F818    43 54 4F 52    C      
 1453	  F81C    23 20          C      
 1454	  F81E                   C      VSEC:	DEFS	2		; SECTOR NUMBER
 1455	  F820    2C 20 46 44    C      	DEFB	', FDC STATUS '
 1456	  F824    43 20 53 54    C      
 1457	  F828    41 54 55 53    C      
 1458	  F82C    20             C      
 1459	  F82D                   C      VSTAT:	DEFS	2		; ERROR STATUS
 1460	  F82F    00             C      	DEFB	0
 1461	  F830    52 45 41 44    C      RMSG:	DEFB	'READ '
 1462	  F834    20             C      
 1463	  F835    57 52 49 54    C      WMSG:	DEFB	'WRITE'
 1464	  F839    45             C      
 1465	                         C      
 1466	                         C      ; DOOR MESSAGE TABLE
 1467	                         C      
 1468	  F83A    0D             C      RDYMSG:	DEFB	0DH
 1469	  F83B    0A             C      	DEFB	0AH
 1470	  F83C    43 68 65 63    C      	DEFM	'Check the disk in drive "'
 1471	  F840    6B 20 74 68    C      
 1472	  F844    65 20 64 69    C      
 1473	  F848    73 6B 20 69    C      
 1474	  F84C    6E 20 64 72    C      
 1475	  F850    69 76 65 20    C      
 1476	  F854    22             C      
 1477	  F855                   C      VDRIVE:	DEFS	1
 1478	  F856    22 2C 20 61    C      	DEFM	'", and close the door.'
 1479	  F85A    6E 64 20 63    C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-36
802FDATA.MAC--DATA DEFINITION MODULE

 1480	  F85E    6C 6F 73 65    C      
 1481	  F862    20 74 68 65    C      
 1482	  F866    20 64 6F 6F    C      
 1483	  F86A    72 2E          C      
 1484	  F86C    0D             C      	DEFB	0DH
 1485	  F86D    0A             C      	DEFB	0AH
 1486	  F86E    00             C      	DEFB	0
 1487	                         C      
 1488	                         C      ; TEMPORARY STORAGES FOR REGISTERS
 1489	                         C      
 1490	  F86F    0000           C      TEMPBC:	DEFW	0
 1491	  F871    0000           C      TEMPDE:	DEFW	0
 1492	  F873    0000           C      TEMPHL:	DEFW	0
 1493	                         C      
 1494	  F875    00             C      JMPSW:	DEFB	0		; FLAG FOR DOOR MESSAGE PRINT
 1495	  F876                   C      DRIVE:	DEFS	1		; STORAGE FOR SAVING CURRENT DRIVE NO
 1496	  F877                   C      TSEC:	DEFS	1		; TARGET SECTOR
 1497	  F878    01             C      MOTFLG:	DEFB	1		; MOTOR ON-OFF FLAG
 1498	                         C      
 1499	                         C      ; HERE ARE THE VERSION 2 DISK PARAMETER TABLES
 1500	                         C      
 1501	  F879                   C      DPBASE:
 1502	                         C      
 1503	                         C      ; DRIVE 0 DISK PARAMETER HEADER
 1504	                         C      
 1505	  F879    0000           C      HEAD0:	DEFW	0		; ADDR. OF SECTOR TRANSLATE TABLE FOR DISK 0
 1506	  F87B    0000           C      	DEFW	0		; BDOS SCRATCH WORDS
 1507	  F87D    0000           C      	DEFW	0		; THREE OF THEM
 1508	  F87F    0000           C      	DEFW	0
 1509	  F881    F8A9           C      	DEFW	DIRBUF		; ADDR. OF DIRECTORY BUFFER FOR DISK 
 1510	  F883    F899           C      	DEFW	DPRMB0		; ADDR. OF DISK PARAMETER BLOCK 0
 1511	  F885    F93F           C      	DEFW	CHKSV0		; ADDR. OF CHECK SCRATCHPAD
 1512	  F887    F929           C      	DEFW	ALOCV0		; ADDR. OF DISK ALLOCATION SCRATCHPAD
 1513	                         C      
 1514	                         C      
 1515	                         C      ; DRIVE 1 DISK PARAMETER HEADER
 1516	                         C      
 1517	  F889    0000           C      HEAD1:	DEFW	0		; ADDR. OF SECTOR TRANSLATE TABLE FOR DISK 1
 1518	  F88B    0000           C      	DEFW	0		; BDOS SCRATCH WORDS
 1519	  F88D    0000           C      	DEFW	0		; THREE OF THEM
 1520	  F88F    0000           C      	DEFW	0
 1521	  F891    F8A9           C      	DEFW	DIRBUF		; ADDR. OF DIRECTORY BUFFER FOR DISK 
 1522	  F893    F899           C      	DEFW	DPRMB1		; ADDR. OF DISK PARAMETER BLOCK 1
 1523	  F895    F965           C      	DEFW	CHKSV1		; ADDR. OF CHECK SCRATCHPAD
 1524	  F897    F94F           C      	DEFW	ALOCV1		; ADDR. OF DISK ALLOCATION SCRATCHPAD
 1525	                         C      
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-37
802FDATA.MAC--DATA DEFINITION MODULE

 1526	                         C      
 1527	                         C      ; HERE ARE THE DISK PARAMETER BLOCKS
 1528	                         C      
 1529	  F899                   C      DPRMB0:		
 1530	  F899                   C      DPRMB1:	
 1531	  F899    0048           C      	DEFW	SPT0		; NO. OF SECTOR PER TRACK
 1532	  F89B    04             C      	DEFB	BSH0		; BLOCK SHIFT FACTOR
 1533	  F89C    0F             C      	DEFB	BLM0		; BLOCK MASK
 1534	  F89D    00             C      	DEFB	EXM0		; EXTENT MASK
 1535	  F89E    00AA           C      	DEFW	DSM0		; DETERMINES TOTAL STORAGE CAPACITY
 1536	  F8A0    003F           C      	DEFW	DRM0		; DETERMINES TOTAL NO. OF DIR. ENTRIES
 1537	  F8A2    80             C      	DEFB	ALL0		; BLOCK ALLOCATION FOR DIRECTORY	
 1538	  F8A3    00             C      	DEFB	ALH0		; HIGH ORDER BYTE OF ABOVE
 1539	  F8A4    0010           C      	DEFW	CKS0		; SIZE OF DIRECTORY CHECK VECTOR
 1540	  F8A6    0002           C      	DEFW	OFF0		; NO. OF TRACKS RESERVED FOR SYSTEM
 1541	                         C      
 1542	                         C      ; MISCELLANEOUS INITIALIZED STORAGE
 1543	                         C      
 1544	  F8A8    80             C      UL1SIZ:	DEFB	80H		; SIZE OF SERIAL PRINTER BUFFER		
 1545	                         C      
 1546	                         C      ; UNALLOCATED STORAGE AREAS
 1547	                         C      
 1548	  F8A9                   C      DIRBUF:	DEFS	128		; DIRECTORY BUFFER
 1549	                         C      
 1550	                         C      ; DRIVE 0 STORAGE AREA
 1551	                         C      
 1552	  F929                   C      ALOCV0:	DEFS	(DSM0/8)+1	; ALLOCATION VECTOR STORAGE
 1553	  F93F                   C      CHKSV0:	DEFS	CKS0		; CHECK VECTOR STORAGE
 1554	                         C      
 1555	                         C      ; DRIVE 1 STORAGE AREA
 1556	                         C      
 1557	  F94F                   C      ALOCV1:	DEFS	(DSM1/8)+1	; ALLOCATION VECTOR STORAGE
 1558	  F965                   C      CHKSV1:	DEFS	CKS1		; CHECK VECTOR STORAGE
 1559	                         C      
 1560	                         C      ; DISK I/O COMMAND PARAMETERS
 1561	                         C      
 1562	  F975                   C      COMAND:	DEFS	1		; CURRENT COMMAND
 1563	  F976                   C      FDDBYT:	DEFS	1		; DRIVE, SIDE, DENSITY, SELECT LATCH
 1564	  F977                   C      RETRY:	DEFS	1		; RETRY COUNT
 1565	  F978                   C      BOOTRY:	DEFS	1		; BOOT RETRY COUNT
 1566	  F979                   C      UNMSTA:	DEFS	1		; UNMASKED VERSION OF ABOVE
 1567	  F97A                   C      DMATAB:	DEFS	2		; DMA INITIALIZE PARAMETER POINTER
 1568	                         C      
 1569	                         C      ; UNITIALIZED RAM DATA AREAS
 1570	                         C      
 1571	  F97C                   C      SEKDSK:	DEFS	1		; SEEK DISK NUMBER
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	1-38
802FDATA.MAC--DATA DEFINITION MODULE

 1572	  F97D                   C      SEKTRK:	DEFS	1		; SEEK TRACK NUMBER
 1573	  F97E                   C      SEKSEC:	DEFS	1		; SEEK SECTOR NUMBER
 1574	                         C      
 1575	  F97F                   C      HSTDSK: DEFS	1		; HOST DISK NUMBER
 1576	  F980                   C      HSTTRK:	DEFS	1		; HOST TRACK NUMBER
 1577	  F981                   C      HSTSEC:	DEFS	1		; HOST SECTOR NUMBER
 1578	                         C      
 1579	  F982                   C      SEKHST:	DEFS	1		; SEEK HOST SECTOR NUMBER
 1580	  F983                   C      HSTACT:	DEFS	1		; HOST ACTIVE FLAG
 1581	  F984                   C      HSTWRT:	DEFS	1		; HOST BUFFER WRITE PENDING FLAG
 1582	                         C      
 1583	  F985                   C      UNACNT:	DEFS	1		; UNALLOATED SECTOR COUNT
 1584	  F986                   C      UNADSK:	DEFS	1		; UNALLOCATED DISK
 1585	  F987                   C      UNATRK:	DEFS	1		; UNALLOCATED TRACK
 1586	  F988                   C      UNASEC:	DEFS	1		; UNALOCATED SECTOR
 1587	                         C      
 1588	  F989                   C      ERFLAG:	DEFS	1		; ERROR REPORTING
 1589	  F98A                   C      RSFLAG:	DEFS	1		; PRE-READ SECTOR FLAG
 1590	  F98B                   C      READOP:	DEFS	1		; 0 IF WRITE OPERATION; 1 IF READ OPER.
 1591	  F98C                   C      WRTYPE:	DEFS	1		; WRITE OPERATION TYPE
 1592	  F98D                   C      DMAADR:	DEFS	2		; LAST DMA ADDRESS
 1593	  F98F                   C      TRKTAB:	DEFS	NODRVS		; CURRENT TRACK TABLE
 1594	  F991                   C      HSTBUF:	DEFS	HSTSIZ		; HOST DISK I/O BUFFER AREA.
 1595	  FA91                   C      UL1CNT:	DEFS	1		; SERIAL PRINTER BUFFER COUNT
 1596	                         C      
 1597	                         C      ; END OF 802FDATA.MAC
 1598	                                
 1599	                                	.DEPHASE 	
 1600	                                	END
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	S
802FDATA.MAC--DATA DEFINITION MODULE

Macros:

Symbols:
ALH0	0000 	ALH1	0000 	ALL0	0080 	ALL1	0080 
ALOCV0	F929 	ALOCV1	F94F 	ASCACK	0006 	ASCCR	000D 
ASCETX	0003 	ASCLF	000A 	BATIN	F418 	BATOUT	F418 
BATST	F41B 	BDOS	E406 	BDOSLN	1600 	BIOS	F200 
BLKSIZ	0800 	BLM0	000F 	BLM1	000F 	BLS0	0800 
BLS1	0800 	BOOMSG	F7E3 	BOOT	F264 	BOOTRY	F978 
BPDE	0020 	BPS0	0100 	BPS1	0100 	BSH0	0004 
BSH1	0004 	CCPLEN	0800 	CHKSV0	F93F 	CHKSV1	F965 
CKS0	0010 	CKS1	0010 	COMAND	F975 	CONIN	F325 
CONOUT	F34F 	CONST	F2FF 	CONT10	F741 	CPMBAS	DC00 
CPMBUF	0080 	CPMSPT	0048 	CRT10	F349 	CRT20	F336 
CRTIN	F332 	CRTOUT	F366 	CRTST	F31C 	CTC0	0008 
CTC1	0009 	CTC2	000A 	CTC3	000B 	CTCTAB	F7AB 
DEFDSK	0004 	DIRBUF	F8A9 	DMA	0010 	DMAADR	F98D 
DMATAB	F97A 	DNRMSK	0080 	DPBASE	F879 	DPRMB0	F899 
DPRMB1	F899 	DRIVE	F876 	DRM0	003F 	DRM1	003F 
DSM0	00AA 	DSM1	00AA 	EPD0	0040 	EPD1	0040 
ERFLAG	F989 	ERR10	F729 	ERRMSG	F7F3 	ERRMSK	00DC 
ERRPRT	F71A 	EXM0	0000 	EXM1	0000 	FDCBSY	0000 
FDCCMD	0014 	FDCCRC	0003 	FDCDAT	0017 	FDCHLD	0005 
FDCIND	0001 	FDCPRT	0006 	FDCRDY	0007 	FDCSEC	0016 
FDCSEE	0004 	FDCTR0	0002 	FDCTRK	0015 	FDD	0018 
FDDBYT	F976 	FRCCMD	00D0 	FTAB	F763 	G10	F77C 
GHEX	F773 	GOCPM	F2D4 	HDSCMD	0034 	HDWINI	F6F5 
HEAD0	F879 	HEAD1	F889 	HOME	F41D 	HOMED	F426 
HSICMD	0054 	HSOCMD	0074 	HSTACT	F983 	HSTBLK	0002 
HSTBUF	F991 	HSTDSK	F97F 	HSTSEC	F981 	HSTSIZ	0100 
HSTSPT	0024 	HSTTRK	F980 	HSTWRT	F984 	IOBYTE	0003 
IODI10	F70B 	IODI20	F70E 	IODISP	F6FF 	JMPSW	F875 
JP	00C3 	LIST	F388 	LISTST	F3ED 	LOGDRV	0004 
LPTLSS	F3F9 	LPTLST	F394 	LPTS10	F402 	MAXDRV	0001 
MOTFLG	F878 	NODRVS	0002 	NOTRYS	000A 	NSIDE0	0002 
NSIDE1	0002 	OFF0	0002 	OFF1	0002 	ONE	F73F 
PIOAC	001E 	PIOAD	001C 	PIOBC	001F 	PIOBD	001D 
PIOERR	0008 	PIOMSK	0038 	PROMSW	0004 	PRTBSY	0005 
PRTENT	F6F0 	PRTINI	F6EE 	PRTMSG	F6E4 	PSPT0	0012 
PSPT1	0012 	PTPPUN	F418 	PTRRDR	F418 	PUNCH	F37C 
RCVRDY	0000 	RDACMD	00C0 	RDMA10	F6DC 	RDSCMD	0080 
RDSTAB	F77F 	RDTCMD	00E0 	RDWT10	F4FC 	RDWT20	F506 
RDWT30	F522 	RDWT40	F526 	RDWT50	F549 	RDWT60	F557 
RDWTCM	F4CC 	RDYMSG	F83A 	READ	F453 	READER	F370 
READHS	F55F 	READOP	F98B 	RECLEN	0080 	RESCMD	0000 
RESD10	F6B3 	RESDMA	F6D9 	RESDSK	F6AA 	RESTOR	F6C5 
RETRY	F977 	REV	F263 	RMSG	F830 	RSFLAG	F98A 
RWHS10	F583 	RWHS20	F59D 	RWHS30	F5B3 	RWHSEC	F56B 
SECMSK	0001 	SECTRN	F450 	SEECMD	0014 	SEEK	F5BB 
802FBIOS.MAC--TELEVIDEO SYSTEM TS-802 CBIOS -- AUG. 25, 1981 	MACRO-80 3.36	17-Mar-80	PAGE	S-1
802FDATA.MAC--DATA DEFINITION MODULE

SEEMSK	0098 	SEKDSK	F97C 	SEKHST	F982 	SEKSEC	F97E 
SEKTRK	F97D 	SELD10	F696 	SELD20	F69E 	SELDRV	F693 
SELDSK	F42B 	SELS10	F673 	SELS20	F68D 	SELSID	F662 
SETDMA	F44B 	SETSEC	F446 	SETTRK	F441 	SIGMSG	F64E 
SIGNON	F7AF 	SIOAC0	000E 	SIOAC1	0022 	SIOAD0	000C 
SIOAD1	0020 	SIOBC0	000F 	SIOBC1	0023 	SIOBD0	000D 
SIOBD1	0021 	SIOTAB	F7A1 	SPD0	0B40 	SPD1	0B40 
SPT0	0048 	SPT1	0048 	STROBE	0000 	TEMPBC	F86F 
TEMPDE	F871 	TEMPHL	F873 	TPD0	0028 	TPD1	0028 
TRKTAB	F98F 	TRXRDY	0002 	TSEC	F877 	TTYIN	F331 
TTYOUT	F35B 	TTYS1	F319 	TTYST	F30B 	UC1IN	F418 
UC1OUT	F418 	UC1ST	F41B 	UL1CNT	FA91 	UL1L10	F3B4 
UL1L20	F3C2 	UL1L30	F3C6 	UL1L40	F3D2 	UL1L50	F3D8 
UL1L60	F3E4 	UL1L70	F3EA 	UL1LSS	F404 	UL1LST	F3A9 
UL1SIZ	F8A8 	UNACNT	F985 	UNADSK	F986 	UNASEC	F988 
UNATRK	F987 	UNMSTA	F979 	UNUSED	F417 	UP1PUN	F418 
UP2PUN	F418 	UR1RDR	F418 	UR2RDR	F418 	VCMD	F7F5 
VDRIVE	F855 	VER	F262 	VSEC	F81E 	VSIDE	F808 
VSTAT	F82D 	VTRK	F812 	WAIT	F5DB 	WAIT10	F5DD 
WAIT20	F5F3 	WAIT30	F623 	WAIT40	F60A 	WAIT50	F617 
WBOO10	F28C 	WBOO20	F29C 	WBOO30	F2C2 	WBOO40	F2CC 
WBOOT	F280 	WMSG	F835 	WRALL	0000 	WRDIR	0001 
WRIT10	F48A 	WRIT20	F4BE 	WRIT30	F4C4 	WRITE	F467 
WRITEH	F566 	WRMSG	F726 	WRTYPE	F98C 	WRUAL	0002 
WTSCMD	00A0 	WTSTAB	F790 	WTTCMD	00F0 	



No  Fatal error(s)



ALH0	 1304#	 1538
ALH1	 1324#
ALL0	 1303#	 1537
ALL1	 1323#
ALOCV0	 1512	 1552#
ALOCV1	 1524	 1557#
ASCACK	  371	 1267#
ASCCR	 1269#
ASCETX	  380	 1266#
ASCLF	 1268#
BATIN	  243	  465#
BATOUT	  280	  468#
BATST	  205	  484#
BDOS	   50#	  179
BDOSLN	   49	  132	 1278#
BIOS	   59#	  176
BLKSIZ	  585	 1329#
BLM0	 1299#	 1301	 1321	 1533
BLM1	 1319#
BLS0	 1297#	 1299	 1329
BLS1	 1317#	 1319
BOOMSG	  152	 1428#
BOOT	   59	  101#
BOOTRY	  120	  149	 1565#
BPDE	 1285#
BPS0	 1291#	 1294	 1330
BPS1	 1311#	 1314
BSH0	 1298#	 1532
BSH1	 1318#
CCPLEN	   50	 1279#
CHKSV0	 1511	 1553#
CHKSV1	 1523	 1558#
CKS0	 1305#	 1539	 1553
CKS1	 1325#	 1558
COMAND	  771	  789	 1103	 1562#
CONIN	   62	  239#	  897
CONOUT	   63	  276#
CONST	   61	  201#	  894
CONT10	 1117	 1119#
CPMBAS	   49#	   50	  130	  187
CPMBUF	  102	  118	  172	 1273#
CPMSPT	  627	 1333#
CRT10	  259	  268#
CRT20	  258#	  263	  267
CRTIN	  242	  256#
CRTOUT	  279	  297#	  299	  333	 1037
CRTST	  204	  228#	  258	  413
CTC0	 1189#

CTC1	 1190#	 1401
CTC2	 1191#
CTC3	 1192#
CTCTAB	 1401#
DEFDSK	  911	 1227#
DIRBUF	 1509	 1521	 1548#
DMA	 1022	 1231#	 1351	 1367
DMAADR	  547	  726	 1592#
DMATAB	  772	  785	 1567#
DNRMSK	 1248#
DPBASE	  527	 1501#
DPRMB0	 1510	 1529#
DPRMB1	 1522	 1530#
DRIVE	  107	  775	  992	 1495#
DRM0	 1302#	 1305	 1536
DRM1	 1322#	 1325
DSM0	 1301#	 1535	 1552
DSM1	 1321#	 1557
EPD0	 1296#	 1302
EPD1	 1316#	 1322
ERFLAG	  653	  747	  793	  800	  813	  868	  887	 1126	 1588#
ERR10	 1107	 1109#
ERRMSG	 1128	 1439#
ERRMSK	  886	 1246#
ERRPRT	  812	 1103#
EXM0	 1300#	 1534
EXM1	 1320#
FDCBSY	  882	 1235#
FDCCMD	  790	  841	  867	  907	  908	 1013	 1215#
FDCCRC	 1238#
FDCDAT	  839	 1218#	 1355	 1371
FDCHLD	 1240#
FDCIND	 1236#
FDCPRT	 1241#
FDCRDY	  801	  869	 1242#
FDCSEC	  942	 1217#
FDCSEE	 1239#
FDCTR0	 1237#
FDCTRK	  833	 1216#
FDD	  265	  946	  976	  987	 1222#
FDDBYT	  932	  945	  972	  975	  986	 1113	 1563#
FRCCMD	  906	 1262#
FTAB	 1121	 1124	 1127	 1134#
G10	 1151	 1154#
GHEX	 1139	 1143	 1149#
GOCPM	  112	  172#
HDSCMD	 1254#
HDWINI	  111	 1059#
HEAD0	 1505#

HEAD1	 1517#
HOME	   67	  498#
HOMED	  500	  504#
HSICMD	 1255#
HSOCMD	 1256#
HSTACT	  122	  184	  502	  661	 1580#
HSTBLK	 1332#	 1333	 1334
HSTBUF	  724	 1360	 1376	 1594#
HSTDSK	  670	  699	  774	  828	  919	  991	 1006	 1575#
HSTSEC	  684	  703	  935	 1577#
HSTSIZ	 1330#	 1332	 1594
HSTSPT	 1331#	 1333
HSTTRK	  677	  701	  835	 1120	 1576#
HSTWRT	  498	  690	  711	  735	  754	 1581#
IOBYTE	  110	 1081	 1274#
IODI10	 1084#	 1085
IODI20	 1082	 1087#
IODISP	  201	  239	  276	  307	  319	  330	  410	 1074#
JMPSW	  865	  873	  918	 1494#
JP	  174	 1276#
LIST	   64	  330#
LISTST	   74	  410#
LOGDRV	  108	  185	 1275#
LPTLSS	  340	  414	  424#
LPTLST	  334	  340#	  341
LPTS10	  436#
MAXDRV	  516	  988	 1335#	 1336
MOTFLG	  266	  947	  951	 1497#
NODRVS	 1336#	 1593
NOTRYS	  119	 1337#
NSIDE0	 1292#	 1294	 1331
NSIDE1	 1312#	 1314
OFF0	 1289#	 1301	 1540
OFF1	 1309#	 1321
ONE	 1115	 1118#
PIOAC	 1197#
PIOAD	  344	  346	  347	  349	  424	 1196#
PIOBC	 1199#
PIOBD	  343	 1198#
PIOERR	 1210#
PIOMSK	 1209#
PROMSW	  101	 1226#
PRTBSY	  430	 1211#
PRTENT	 1050#
PRTINI	  786	 1048#	 1061
PRTMSG	  104	  153	  923	 1032#	 1039	 1129
PSPT0	  936	  939	 1293#	 1294	 1331
PSPT1	 1313#	 1314
PTPPUN	  322	  475#

PTRRDR	  310	  471#
PUNCH	   65	  319#
RCVRDY	  229	  367	  449	 1203#
RDACMD	 1259#
RDMA10	 1021#	 1023
RDSCMD	  763	 1257#
RDSTAB	  764	 1351#
RDTCMD	 1260#
RDWT10	  672	  679	  690#
RDWT20	  665	  692	  698#
RDWT30	  706	  710#
RDWT40	  686	  715#
RDWT50	  730	  740#
RDWT60	  746	  753#
RDWTCM	  570	  641	  652#
RDYMSG	  922	 1468#
READ	   72	  144	  563#
READER	   66	  307#
READHS	  707	  762#
READOP	  566	  577	  728	 1590#
RECLEN	  132	  165	 1277#
RESCMD	 1012	 1252#
RESD10	  990#	  996
RESDMA	  799	  909	 1019#
RESDSK	  124	  985#	 1059
RESTOR	  809	  994	 1006#
RETRY	  783	  804	 1564#
REV	   96#
RMSG	 1106	 1461#
RSFLAG	  567	  640	  648	  704	 1589#
RWHS10	  785#	  810
RWHS20	  788	  792	  799#
RWHS30	  808	  812#
RWHSEC	  765	  771#
SECMSK	  716	 1334#
SECTRN	   75	  555#
SEECMD	  840	 1253#
SEEK	  787	  827#
SEEMSK	  846	 1247#
SEKDSK	  515	  587	  604	  669	  698	 1571#
SEKHST	  657	  683	  702	 1579#
SEKSEC	  542	  591	  618	  654	  715	 1573#
SEKTRK	  505	  535	  589	  611	  676	  700	 1572#
SELD10	  966#	  970
SELD20	  967	  972#
SELDRV	  777	  963#	  993
SELDSK	   68	  129	  513#
SELS10	  937	  941#
SELS20	  953#	  956

SELSID	  778	  932#
SETDMA	   71	  139	  173	  547#
SETSEC	   70	  143	  541#
SETTRK	   69	  141	  534#
SIGMSG	  879	  917#
SIGNON	  103	 1408#
SIOAC0	 1175#
SIOAC1	 1183#
SIOAD0	 1174#
SIOAD1	 1182#
SIOBC0	  228	  297	 1177#
SIOBC1	  213	  214	  366	  377	  389	  448	 1185#	 1387
SIOBD0	  268	  301	 1176#
SIOBD1	  290	  369	  381	  394	 1184#
SIOTAB	 1060	 1387#
SPD0	 1295#	 1301
SPD1	 1315#	 1321
SPT0	  159	 1294#	 1295	 1301	 1531
SPT1	 1314#	 1315	 1321
STROBE	  345	  348	 1208#
TEMPBC	  860	  891	  904	 1490#
TEMPDE	  861	  890	  903	 1491#
TEMPHL	  862	  889	  902	 1492#
TPD0	 1290#	 1295
TPD1	 1310#	 1315
TRKTAB	  827	 1007	 1593#
TRXRDY	  298	  378	  390	 1204#
TSEC	  943	 1123	 1496#
TTYIN	  241	  248#	  309
TTYOUT	  278	  286#	  287	  321	  332
TTYS1	  217	  221#
TTYST	  203	  212#	  286	  412
UC1IN	  244	  466#
UC1OUT	  281	  469#
UC1ST	  206	  485#
UL1CNT	  182	  363	  442	 1595#
UL1L10	  366#	  387
UL1L20	  368	  373#
UL1L30	  377#	  379	  386
UL1L40	  375	  384#
UL1L50	  382	  389#	  391	  400	  403
UL1L60	  372	  397#
UL1L70	  399	  402#
UL1LSS	  415	  442#
UL1LST	  335	  358#
UL1SIZ	  358	  443	 1544#
UNACNT	  183	  564	  586	  596	  603	  646	 1583#
UNADSK	  588	  605	 1584#
UNASEC	  592	  619	 1586#

UNATRK	  590	  612	  633	  635	 1585#
UNMSTA	  885	 1566#
UNUSED	   76	   77	   78	   79	   80	  460#
UP1PUN	  323	  476#
UP2PUN	  324	  477#
UR1RDR	  311	  472#
UR2RDR	  312	  473#
VCMD	 1109	 1441#
VDRIVE	  921	 1477#
VER	   95#
VSEC	 1122	 1454#
VSIDE	 1112	 1446#
VSTAT	 1125	 1459#
VTRK	 1119	 1450#
WAIT	  791	  845	  856#	 1014
WAIT10	  857#	  858
WAIT20	  867#	  883
WAIT30	  875	  894#
WAIT40	  880#	  896	  899
WAIT50	  870	  889#
WBOO10	  124#	  151
WBOO20	  134#	  168
WBOO30	  145	  156#
WBOO40	  160	  164#
WBOOT	   60	  118#	  912
WMSG	 1108	 1463#
WRALL	 1167#
WRDIR	  745	 1168#
WRIT10	  581	  596#
WRIT20	  628	  639#
WRIT30	  598	  607	  614	  621	  645#
WRITE	   73	  576#
WRITEH	  693	  755	  767#
WRMSG	 1105	 1108#
WRTYPE	  569	  579	  744	 1591#
WRUAL	  568	  580	 1169#
WTSCMD	  768	 1258#
WTSTAB	  769	 1367#
WTTCMD	 1261#

867#	  883
WAIT30	  875	  894#
WAIT40	  880#	  896	  899
WAIT50	  870	  889#
WBOO10	  124#	  151
WBOO20	  134#	  1